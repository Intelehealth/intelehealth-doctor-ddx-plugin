import { Component, Input, Output, EventEmitter } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../../services/aiddx.service";
import * as i2 from "@angular/common";
import * as i3 from "@ngx-translate/core";
// import { dummyPayload, response } from '../token';
export class AillmddxComponent {
    ddxSvc;
    patientInfo;
    visit;
    existingDiagnosis = [];
    diagnosisSelected = new EventEmitter();
    notes;
    isLoading = false;
    hasError = false;
    noData = false;
    insufficientData = false;
    conclusion = '';
    questions = [
        {
            title: 'Key symptoms and their characteristics',
            items: [
                'Can you describe the rash in more detail?',
                'Are there any blackheads or whiteheads?',
                'Does the rash itch or burn? Does it get worse after sweating or sun exposure?',
                'When you say the rash is transient, how long does it last before disappearing?',
                'Does it reappear in the same location?'
            ]
        },
    ];
    diagnosisList = [];
    furtherQuestionsList = [];
    selectedDiagnosis = [];
    constructor(ddxSvc) {
        this.ddxSvc = ddxSvc;
    }
    ngOnInit() { }
    getAIDiagnosis(notes) {
        const payload = this.ddxSvc.getDDxPayload(this.patientInfo, this.visit, notes);
        this.isLoading = true;
        this.diagnosisList = [];
        this.furtherQuestionsList = [];
        this.ddxSvc.getAIDiagnosis(payload).subscribe({
            next: (data) => {
                if (data?.conclusion)
                    this.conclusion = data?.conclusion;
                if (data.result.data.result.length > 0) {
                    this.noData = false;
                    this.diagnosisList = data.result.data.result.map(v => {
                        return {
                            ...v,
                            diagnosis: v?.diagnosis?.replace(/\s*\(.*?\)\s*/g, ''),
                            rationale: this.ddxSvc.markdownit(v?.rationale)
                        };
                    });
                }
                else {
                    this.noData = true;
                }
                if (data.result.data.further_questions.length > 0) {
                    this.furtherQuestionsList = data.result.data.further_questions.map(q => {
                        const key = Object.keys(q)[0];
                        return q[key];
                    });
                }
            },
            error: (err) => {
                this.hasError = true;
                this.isLoading = false;
            },
            complete: () => {
                this.isLoading = false;
            }
        });
        // setTimeout(() => {
        //   if (response.result.length > 0) {
        //     this.noData = false;
        //     this.conclusion = response?.conclusion;
        //     this.diagnosisList = response.result.map(v => ({ ...v, diagnosis: v?.diagnosis?.replace(/\s*\(.*?\)\s*/g, '') }));
        //   } else {
        //     this.noData = true;
        //   }
        //   this.isLoading = false;
        // }, 3000);
    }
    getAIDiagnosisWithRetry(notes) {
        const MAX_RETRIES = 3;
        let retryCount = 0;
        const payload = this.ddxSvc.getDDxPayload(this.patientInfo, this.visit, notes);
        const attemptDiagnosis = () => {
            this.isLoading = true;
            this.diagnosisList = [];
            this.furtherQuestionsList = [];
            this.ddxSvc.getAIDiagnosis(payload).subscribe({
                next: (data) => {
                    if (data?.conclusion)
                        this.conclusion = data?.conclusion;
                    if (data.result.data.result.length > 0) {
                        this.noData = false;
                        this.diagnosisList = data.result.data.result.map(v => {
                            return {
                                ...v,
                                diagnosis: v?.diagnosis?.replace(/\s*\(.*?\)\s*/g, ''),
                                rationale: this.ddxSvc.markdownit(v?.rationale)
                            };
                        });
                    }
                    else {
                        this.noData = true;
                    }
                    if (data.result.data.further_questions.length > 0) {
                        this.furtherQuestionsList = data.result.data.further_questions.map(q => {
                            const key = Object.keys(q)[0];
                            return q[key];
                        });
                    }
                    this.isLoading = false;
                },
                error: (err) => {
                    retryCount++;
                    if (retryCount < MAX_RETRIES) {
                        console.log(`Retry attempt ${retryCount} for getAIDiagnosis`);
                        setTimeout(() => {
                            attemptDiagnosis();
                        }, 1000);
                    }
                    else {
                        this.hasError = true;
                        this.isLoading = false;
                        console.error('Failed to get AI diagnosis after 3 attempts:', err);
                    }
                },
                complete: () => {
                    this.isLoading = false;
                }
            });
        };
        attemptDiagnosis();
    }
    onTryAgain() {
        this.getAIDiagnosis(this.notes);
    }
    onAIDiagnosisChange(event) {
        if (!event) {
            this.selectedDiagnosis = [];
        }
        else if (Array.isArray(event)) {
            this.selectedDiagnosis = [...event];
        }
        else {
            const index = this.selectedDiagnosis.indexOf(event);
            if (index > -1) {
                this.selectedDiagnosis = this.selectedDiagnosis.filter(d => d !== event);
            }
            else {
                this.selectedDiagnosis = [...this.selectedDiagnosis, event];
            }
        }
        this.diagnosisSelected.emit([...this.selectedDiagnosis]);
    }
    isDiagnosisExists(diagnosis) {
        return this.existingDiagnosis.some(d => d.diagnosisName === diagnosis);
    }
    isDiagnosisSelected(diagnosis) {
        return this.selectedDiagnosis.includes(diagnosis) || this.existingDiagnosis.some(d => d?.diagnosisName === diagnosis);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AillmddxComponent, deps: [{ token: i1.AiddxService }], target: i0.ɵɵFactoryTarget.Component });
    static ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: AillmddxComponent, selector: "app-aillmddx", inputs: { patientInfo: "patientInfo", visit: "visit", existingDiagnosis: "existingDiagnosis", notes: "notes" }, outputs: { diagnosisSelected: "diagnosisSelected" }, ngImport: i0, template: "<ng-container *ngIf=\"!diagnosisList.length\">\r\n    <div class=\"d-flex justify-content-center mt-2\">\r\n        <div class=\"erorr-container alert text-center p-4 d-flex flex-column align-items-center\">\r\n            <ng-container *ngIf=\"!isLoading && (hasError || noData)\">\r\n                <div class=\"text-danger\">\r\n                    <i class=\"bi bi-exclamation-triangle-fill\"></i>\r\n                    <img src=\"assets/images/login/interneticon.png\" alt=\"Warning\" class=\"warning-icon mr-2\" />\r\n                    <span *ngIf=\"hasError\" class=\"ms-2\">An unexpected issue occurred</span>\r\n                    <span *ngIf=\"noData\" class=\"ms-2\">The input provided does not have enough clinical details for an AI-assistant assessment.</span>\r\n                </div>\r\n                <button *ngIf=\"!noData\" type=\"button\" class=\"try-again-btn mt-3\" (click)=\"onTryAgain()\">\r\n                    {{'Try again'|translate}}\r\n                </button>\r\n            </ng-container>\r\n\r\n            <button *ngIf=\"isLoading\" class=\"stats-loading\">\r\n                <div class=\"eins\"></div>\r\n                <div class=\"zwei\"></div>\r\n                <div class=\"drei\"></div>\r\n            </button>\r\n\r\n            <div *ngIf=\"isLoading\" class=\"mt-3\">\r\n                <i class=\"bi bi-exclamation-triangle-fill\"></i>\r\n                <span class=\"ms-2 loading-text\">Please wait while the results are being generated.</span>\r\n            </div>\r\n\r\n        </div>\r\n    </div>\r\n</ng-container>\r\n\r\n<ng-container *ngIf=\"diagnosisList.length\" class=\"mt-2\">\r\n    <p class=\"note-con ml-2\">\r\n        <span class=\"note-label\">Note:</span>\r\n        This information is AI generated. Please rely on your medical judgement while referring to it.\r\n    </p>\r\n    <div class=\"intel-accordion-title\">\r\n        <h6 class=\"mt-1 ml-2 diffrential-diagnosis\">Differential Diagnosis</h6>\r\n    </div>\r\n    <div class=\"intel-accordion-title\">\r\n        <p class=\"text-muted mb-3 diagnosis-list ml-2\">\r\n            Select the diagnosis based on your medical judgement.\r\n        </p>\r\n    </div>\r\n\r\n    <div class=\"diagnosis-container p-3\">\r\n        <div *ngFor=\"let diagnosis of diagnosisList\" \r\n             class=\"d-flex align-items-center mb-2\"\r\n             [class.disabled-diagnosis]=\"isDiagnosisExists(diagnosis.diagnosis)\">\r\n            <input type=\"checkbox\" class=\"custom-checkbox me-2\"\r\n                [checked]=\"isDiagnosisSelected(diagnosis.diagnosis)\"\r\n                [disabled]=\"isDiagnosisExists(diagnosis.diagnosis)\"\r\n                (change)=\"onAIDiagnosisChange(diagnosis.diagnosis)\">\r\n            <label class=\"fw-bold\" [class.text-muted]=\"isDiagnosisExists(diagnosis.diagnosis)\">\r\n                {{ diagnosis.diagnosis }}\r\n                <span class=\"text-muted ms-2\">(likely {{ diagnosis.likelihood }})</span>\r\n            </label>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"rationale-container\">\r\n        <h5 class=\"fw-bold rationale\">Rationale</h5>\r\n        <div *ngFor=\"let rationale of diagnosisList; let i = index\" class=\"rationale-item p-3 mb-2\">\r\n            <h3 class=\"fw-bold\">\r\n                {{ i + 1 }}. {{ rationale.diagnosis }}\r\n                <span class=\"text-muted small\">(likely {{ rationale.likelihood }})</span>\r\n            </h3>\r\n            <p class=\"rationale-description\" [innerHTML]=\"rationale.rationale\"></p>\r\n        </div>\r\n    </div>\r\n\r\n</ng-container>\r\n\r\n<div *ngIf=\"conclusion\" class=\"conclusion-card\">\r\n    <div class=\"conclusion-header\">\r\n        <h2>Conclusion</h2>\r\n    </div>\r\n    <div class=\"conclusion-body\">\r\n        <p>{{ conclusion }}</p>\r\n    </div>\r\n</div>\r\n\r\n<div *ngIf=\"furtherQuestionsList.length\" class=\"rationale-container\">\r\n    <h2 class=\"fw-bold\">Further questions</h2>\r\n    <div *ngFor=\"let question of furtherQuestionsList; let i = index\" class=\"fq-item\">\r\n        <li>{{ question }}</li>\r\n    </div>\r\n</div>", styles: ["@charset \"UTF-8\";.try-again-btn{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.diffrential-diagnosis{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.diagnosis-list{font-weight:400;font-size:14px;line-height:21px;letter-spacing:0%}.diagnosis-container{background-color:#faf7fc;border-radius:10px;padding:15px}.custom-checkbox{appearance:none;width:18px;height:18px;border:1px solid #B0ADBE;border-radius:4px;position:relative;cursor:pointer;background-color:transparent;margin-right:10px;margin-bottom:9px}.custom-checkbox:checked{background-color:#0fd197}.custom-checkbox:checked:after{content:\"\\2713\";font-size:14px;font-weight:700;color:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.rationale-container{background-color:#faf7fc;border-radius:10px;padding:15px}.rationale-container h2{font-size:16px;font-weight:700;line-height:24px;color:#101828}.rationale-container .fq-item{margin-left:20px}.rationale-item{border-bottom:1.5px solid rgba(178,175,190,.2)}.rationale{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.rationale-description{font-weight:400;font-size:16px;line-height:24px;letter-spacing:0%;margin-left:13px}.stats-loading{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.stats-loading div{background:#0060ff;display:inline-block;height:8px;width:8px;border-radius:100%;animation:bouncedelay 1.4s infinite ease-in-out;animation-fill-mode:both}.stats-loading div.eins{animation-delay:-.32s}.stats-loading div.zwei{animation-delay:-.16s}@keyframes bouncedelay{0%,80%,to{transform:scale(0);opacity:0}40%{transform:scale(1);opacity:100}}.loading-text{font-weight:400;font-size:12px;line-height:18px;color:#7f7b92}.conclusion-card{background:#fff;border-radius:10px;margin:20px 0;box-shadow:0 1px 3px #1018281a,0 1px 2px #1018280f}.conclusion-card .conclusion-header{padding:16px 24px;border-bottom:1px solid #EAECF0}.conclusion-card .conclusion-header h2{font-size:16px;font-weight:700;line-height:24px;margin:0;color:#101828}.conclusion-card .conclusion-body{padding:24px}.conclusion-card .conclusion-body p{margin:0;font-size:14px;line-height:20px;color:#344054;font-weight:400}.note-con{background:#f8f9fa;border-radius:4px;padding:12px 16px;margin:16px 0;font-size:14px;line-height:20px;color:#212529}.note-con .note-label{font-weight:600;margin-right:4px;color:#dc3545}.disabled-diagnosis{opacity:.7;cursor:not-allowed}.disabled-diagnosis .custom-checkbox{cursor:not-allowed}.disabled-diagnosis .text-muted{opacity:.7}.warning-icon{height:50px;width:50px}.erorr-container{height:150px;background-color:#faf7fc;border-radius:10px;width:100%}\n"], dependencies: [{ kind: "directive", type: i2.NgForOf, selector: "[ngFor][ngForOf]" }, { kind: "directive", type: i2.NgIf, selector: "[ngIf]" }, { kind: "pipe", type: i3.TranslatePipe, name: "translate" }] });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AillmddxComponent, decorators: [{
            type: Component,
            args: [{ selector: 'app-aillmddx', template: "<ng-container *ngIf=\"!diagnosisList.length\">\r\n    <div class=\"d-flex justify-content-center mt-2\">\r\n        <div class=\"erorr-container alert text-center p-4 d-flex flex-column align-items-center\">\r\n            <ng-container *ngIf=\"!isLoading && (hasError || noData)\">\r\n                <div class=\"text-danger\">\r\n                    <i class=\"bi bi-exclamation-triangle-fill\"></i>\r\n                    <img src=\"assets/images/login/interneticon.png\" alt=\"Warning\" class=\"warning-icon mr-2\" />\r\n                    <span *ngIf=\"hasError\" class=\"ms-2\">An unexpected issue occurred</span>\r\n                    <span *ngIf=\"noData\" class=\"ms-2\">The input provided does not have enough clinical details for an AI-assistant assessment.</span>\r\n                </div>\r\n                <button *ngIf=\"!noData\" type=\"button\" class=\"try-again-btn mt-3\" (click)=\"onTryAgain()\">\r\n                    {{'Try again'|translate}}\r\n                </button>\r\n            </ng-container>\r\n\r\n            <button *ngIf=\"isLoading\" class=\"stats-loading\">\r\n                <div class=\"eins\"></div>\r\n                <div class=\"zwei\"></div>\r\n                <div class=\"drei\"></div>\r\n            </button>\r\n\r\n            <div *ngIf=\"isLoading\" class=\"mt-3\">\r\n                <i class=\"bi bi-exclamation-triangle-fill\"></i>\r\n                <span class=\"ms-2 loading-text\">Please wait while the results are being generated.</span>\r\n            </div>\r\n\r\n        </div>\r\n    </div>\r\n</ng-container>\r\n\r\n<ng-container *ngIf=\"diagnosisList.length\" class=\"mt-2\">\r\n    <p class=\"note-con ml-2\">\r\n        <span class=\"note-label\">Note:</span>\r\n        This information is AI generated. Please rely on your medical judgement while referring to it.\r\n    </p>\r\n    <div class=\"intel-accordion-title\">\r\n        <h6 class=\"mt-1 ml-2 diffrential-diagnosis\">Differential Diagnosis</h6>\r\n    </div>\r\n    <div class=\"intel-accordion-title\">\r\n        <p class=\"text-muted mb-3 diagnosis-list ml-2\">\r\n            Select the diagnosis based on your medical judgement.\r\n        </p>\r\n    </div>\r\n\r\n    <div class=\"diagnosis-container p-3\">\r\n        <div *ngFor=\"let diagnosis of diagnosisList\" \r\n             class=\"d-flex align-items-center mb-2\"\r\n             [class.disabled-diagnosis]=\"isDiagnosisExists(diagnosis.diagnosis)\">\r\n            <input type=\"checkbox\" class=\"custom-checkbox me-2\"\r\n                [checked]=\"isDiagnosisSelected(diagnosis.diagnosis)\"\r\n                [disabled]=\"isDiagnosisExists(diagnosis.diagnosis)\"\r\n                (change)=\"onAIDiagnosisChange(diagnosis.diagnosis)\">\r\n            <label class=\"fw-bold\" [class.text-muted]=\"isDiagnosisExists(diagnosis.diagnosis)\">\r\n                {{ diagnosis.diagnosis }}\r\n                <span class=\"text-muted ms-2\">(likely {{ diagnosis.likelihood }})</span>\r\n            </label>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"rationale-container\">\r\n        <h5 class=\"fw-bold rationale\">Rationale</h5>\r\n        <div *ngFor=\"let rationale of diagnosisList; let i = index\" class=\"rationale-item p-3 mb-2\">\r\n            <h3 class=\"fw-bold\">\r\n                {{ i + 1 }}. {{ rationale.diagnosis }}\r\n                <span class=\"text-muted small\">(likely {{ rationale.likelihood }})</span>\r\n            </h3>\r\n            <p class=\"rationale-description\" [innerHTML]=\"rationale.rationale\"></p>\r\n        </div>\r\n    </div>\r\n\r\n</ng-container>\r\n\r\n<div *ngIf=\"conclusion\" class=\"conclusion-card\">\r\n    <div class=\"conclusion-header\">\r\n        <h2>Conclusion</h2>\r\n    </div>\r\n    <div class=\"conclusion-body\">\r\n        <p>{{ conclusion }}</p>\r\n    </div>\r\n</div>\r\n\r\n<div *ngIf=\"furtherQuestionsList.length\" class=\"rationale-container\">\r\n    <h2 class=\"fw-bold\">Further questions</h2>\r\n    <div *ngFor=\"let question of furtherQuestionsList; let i = index\" class=\"fq-item\">\r\n        <li>{{ question }}</li>\r\n    </div>\r\n</div>", styles: ["@charset \"UTF-8\";.try-again-btn{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.diffrential-diagnosis{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.diagnosis-list{font-weight:400;font-size:14px;line-height:21px;letter-spacing:0%}.diagnosis-container{background-color:#faf7fc;border-radius:10px;padding:15px}.custom-checkbox{appearance:none;width:18px;height:18px;border:1px solid #B0ADBE;border-radius:4px;position:relative;cursor:pointer;background-color:transparent;margin-right:10px;margin-bottom:9px}.custom-checkbox:checked{background-color:#0fd197}.custom-checkbox:checked:after{content:\"\\2713\";font-size:14px;font-weight:700;color:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.rationale-container{background-color:#faf7fc;border-radius:10px;padding:15px}.rationale-container h2{font-size:16px;font-weight:700;line-height:24px;color:#101828}.rationale-container .fq-item{margin-left:20px}.rationale-item{border-bottom:1.5px solid rgba(178,175,190,.2)}.rationale{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.rationale-description{font-weight:400;font-size:16px;line-height:24px;letter-spacing:0%;margin-left:13px}.stats-loading{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.stats-loading div{background:#0060ff;display:inline-block;height:8px;width:8px;border-radius:100%;animation:bouncedelay 1.4s infinite ease-in-out;animation-fill-mode:both}.stats-loading div.eins{animation-delay:-.32s}.stats-loading div.zwei{animation-delay:-.16s}@keyframes bouncedelay{0%,80%,to{transform:scale(0);opacity:0}40%{transform:scale(1);opacity:100}}.loading-text{font-weight:400;font-size:12px;line-height:18px;color:#7f7b92}.conclusion-card{background:#fff;border-radius:10px;margin:20px 0;box-shadow:0 1px 3px #1018281a,0 1px 2px #1018280f}.conclusion-card .conclusion-header{padding:16px 24px;border-bottom:1px solid #EAECF0}.conclusion-card .conclusion-header h2{font-size:16px;font-weight:700;line-height:24px;margin:0;color:#101828}.conclusion-card .conclusion-body{padding:24px}.conclusion-card .conclusion-body p{margin:0;font-size:14px;line-height:20px;color:#344054;font-weight:400}.note-con{background:#f8f9fa;border-radius:4px;padding:12px 16px;margin:16px 0;font-size:14px;line-height:20px;color:#212529}.note-con .note-label{font-weight:600;margin-right:4px;color:#dc3545}.disabled-diagnosis{opacity:.7;cursor:not-allowed}.disabled-diagnosis .custom-checkbox{cursor:not-allowed}.disabled-diagnosis .text-muted{opacity:.7}.warning-icon{height:50px;width:50px}.erorr-container{height:150px;background-color:#faf7fc;border-radius:10px;width:100%}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.AiddxService }]; }, propDecorators: { patientInfo: [{
                type: Input
            }], visit: [{
                type: Input
            }], existingDiagnosis: [{
                type: Input
            }], diagnosisSelected: [{
                type: Output
            }], notes: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlsbG1kZHguY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYWlkZHgtbGlicmFyeS9zcmMvbGliL2FpbGxtZGR4L2FpbGxtZGR4LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FpZGR4LWxpYnJhcnkvc3JjL2xpYi9haWxsbWRkeC9haWxsbWRkeC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7OztBQUV2RSxxREFBcUQ7QUFPckQsTUFBTSxPQUFPLGlCQUFpQjtJQTRCbEI7SUEzQkQsV0FBVyxDQUFNO0lBQ2pCLEtBQUssQ0FBTTtJQUNYLGlCQUFpQixHQUFVLEVBQUUsQ0FBQztJQUM3QixpQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBWSxDQUFDO0lBQ2xELEtBQUssQ0FBUztJQUN2QixTQUFTLEdBQUcsS0FBSyxDQUFDO0lBQ2xCLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFDakIsTUFBTSxHQUFHLEtBQUssQ0FBQztJQUNmLGdCQUFnQixHQUFHLEtBQUssQ0FBQztJQUN6QixVQUFVLEdBQVcsRUFBRSxDQUFDO0lBQ3hCLFNBQVMsR0FBRztRQUNWO1lBQ0UsS0FBSyxFQUFFLHdDQUF3QztZQUMvQyxLQUFLLEVBQUU7Z0JBQ0wsMkNBQTJDO2dCQUMzQyx5Q0FBeUM7Z0JBQ3pDLCtFQUErRTtnQkFDL0UsZ0ZBQWdGO2dCQUNoRix3Q0FBd0M7YUFDekM7U0FDRjtLQUNGLENBQUM7SUFDRixhQUFhLEdBQVEsRUFBRSxDQUFBO0lBQ3ZCLG9CQUFvQixHQUFRLEVBQUUsQ0FBQTtJQUM5QixpQkFBaUIsR0FBYSxFQUFFLENBQUM7SUFFakMsWUFDVSxNQUFvQjtRQUFwQixXQUFNLEdBQU4sTUFBTSxDQUFjO0lBQzFCLENBQUM7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QUFpQjtzQkFBMUIsTUFBTTtnQkFDRSxLQUFLO3NCQUFiLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBaWRkeFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9haWRkeC5zZXJ2aWNlJztcclxuLy8gaW1wb3J0IHsgZHVtbXlQYXlsb2FkLCByZXNwb25zZSB9IGZyb20gJy4uL3Rva2VuJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnYXBwLWFpbGxtZGR4JyxcclxuICB0ZW1wbGF0ZVVybDogJy4vYWlsbG1kZHguY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL2FpbGxtZGR4LmNvbXBvbmVudC5zY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIEFpbGxtZGR4Q29tcG9uZW50IHtcclxuICBASW5wdXQoKSBwYXRpZW50SW5mbzogYW55O1xyXG4gIEBJbnB1dCgpIHZpc2l0OiBhbnk7XHJcbiAgQElucHV0KCkgZXhpc3RpbmdEaWFnbm9zaXM6IGFueVtdID0gW107XHJcbiAgQE91dHB1dCgpIGRpYWdub3Npc1NlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmdbXT4oKTtcclxuICBASW5wdXQoKSBub3Rlczogc3RyaW5nO1xyXG4gIGlzTG9hZGluZyA9IGZhbHNlO1xyXG4gIGhhc0Vycm9yID0gZmFsc2U7XHJcbiAgbm9EYXRhID0gZmFsc2U7XHJcbiAgaW5zdWZmaWNpZW50RGF0YSA9IGZhbHNlO1xyXG4gIGNvbmNsdXNpb246IHN0cmluZyA9ICcnO1xyXG4gIHF1ZXN0aW9ucyA9IFtcclxuICAgIHtcclxuICAgICAgdGl0bGU6ICdLZXkgc3ltcHRvbXMgYW5kIHRoZWlyIGNoYXJhY3RlcmlzdGljcycsXHJcbiAgICAgIGl0ZW1zOiBbXHJcbiAgICAgICAgJ0NhbiB5b3UgZGVzY3JpYmUgdGhlIHJhc2ggaW4gbW9yZSBkZXRhaWw/JyxcclxuICAgICAgICAnQXJlIHRoZXJlIGFueSBibGFja2hlYWRzIG9yIHdoaXRlaGVhZHM/JyxcclxuICAgICAgICAnRG9lcyB0aGUgcmFzaCBpdGNoIG9yIGJ1cm4/IERvZXMgaXQgZ2V0IHdvcnNlIGFmdGVyIHN3ZWF0aW5nIG9yIHN1biBleHBvc3VyZT8nLFxyXG4gICAgICAgICdXaGVuIHlvdSBzYXkgdGhlIHJhc2ggaXMgdHJhbnNpZW50LCBob3cgbG9uZyBkb2VzIGl0IGxhc3QgYmVmb3JlIGRpc2FwcGVhcmluZz8nLFxyXG4gICAgICAgICdEb2VzIGl0IHJlYXBwZWFyIGluIHRoZSBzYW1lIGxvY2F0aW9uPydcclxuICAgICAgXVxyXG4gICAgfSxcclxuICBdO1xyXG4gIGRpYWdub3Npc0xpc3Q6IGFueSA9IFtdXHJcbiAgZnVydGhlclF1ZXN0aW9uc0xpc3Q6IGFueSA9IFtdXHJcbiAgc2VsZWN0ZWREaWFnbm9zaXM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBkZHhTdmM6IEFpZGR4U2VydmljZSxcclxuICApIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpIHt9XHJcblxyXG4gIHB1YmxpYyBnZXRBSURpYWdub3Npcyhub3Rlcz86IHN0cmluZykge1xyXG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZGR4U3ZjLmdldEREeFBheWxvYWQodGhpcy5wYXRpZW50SW5mbywgdGhpcy52aXNpdCwgbm90ZXMpO1xyXG4gICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xyXG4gICAgdGhpcy5kaWFnbm9zaXNMaXN0ID0gW107XHJcbiAgICB0aGlzLmZ1cnRoZXJRdWVzdGlvbnNMaXN0ID0gW107XHJcbiAgICB0aGlzLmRkeFN2Yy5nZXRBSURpYWdub3NpcyhwYXlsb2FkKS5zdWJzY3JpYmUoe1xyXG4gICAgICBuZXh0OiAoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKGRhdGE/LmNvbmNsdXNpb24pIHRoaXMuY29uY2x1c2lvbiA9IGRhdGE/LmNvbmNsdXNpb247XHJcbiAgICAgICAgaWYgKGRhdGEucmVzdWx0LmRhdGEucmVzdWx0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHRoaXMubm9EYXRhID0gZmFsc2U7XHJcbiAgICAgICAgICB0aGlzLmRpYWdub3Npc0xpc3QgPSBkYXRhLnJlc3VsdC5kYXRhLnJlc3VsdC5tYXAodiA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgLi4udixcclxuICAgICAgICAgICAgICBkaWFnbm9zaXM6IHY/LmRpYWdub3Npcz8ucmVwbGFjZSgvXFxzKlxcKC4qP1xcKVxccyovZywgJycpLFxyXG4gICAgICAgICAgICAgIHJhdGlvbmFsZTogdGhpcy5kZHhTdmMubWFya2Rvd25pdCh2Py5yYXRpb25hbGUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLm5vRGF0YSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmKGRhdGEucmVzdWx0LmRhdGEuZnVydGhlcl9xdWVzdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgdGhpcy5mdXJ0aGVyUXVlc3Rpb25zTGlzdCA9IGRhdGEucmVzdWx0LmRhdGEuZnVydGhlcl9xdWVzdGlvbnMubWFwKHEgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBrZXkgPSBPYmplY3Qua2V5cyhxKVswXTtcclxuICAgICAgICAgICAgcmV0dXJuIHFba2V5XTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgZXJyb3I6IChlcnI6IGFueSkgPT4ge1xyXG4gICAgICAgIHRoaXMuaGFzRXJyb3IgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XHJcbiAgICAgIH0sXHJcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAvLyAgIGlmIChyZXNwb25zZS5yZXN1bHQubGVuZ3RoID4gMCkge1xyXG4gICAgLy8gICAgIHRoaXMubm9EYXRhID0gZmFsc2U7XHJcbiAgICAvLyAgICAgdGhpcy5jb25jbHVzaW9uID0gcmVzcG9uc2U/LmNvbmNsdXNpb247XHJcbiAgICAvLyAgICAgdGhpcy5kaWFnbm9zaXNMaXN0ID0gcmVzcG9uc2UucmVzdWx0Lm1hcCh2ID0+ICh7IC4uLnYsIGRpYWdub3Npczogdj8uZGlhZ25vc2lzPy5yZXBsYWNlKC9cXHMqXFwoLio/XFwpXFxzKi9nLCAnJykgfSkpO1xyXG4gICAgLy8gICB9IGVsc2Uge1xyXG4gICAgLy8gICAgIHRoaXMubm9EYXRhID0gdHJ1ZTtcclxuICAgIC8vICAgfVxyXG4gICAgLy8gICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xyXG4gICAgLy8gfSwgMzAwMCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0QUlEaWFnbm9zaXNXaXRoUmV0cnkobm90ZXM/OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IE1BWF9SRVRSSUVTID0gMztcclxuICAgIGxldCByZXRyeUNvdW50ID0gMDtcclxuICAgIGNvbnN0IHBheWxvYWQgPSB0aGlzLmRkeFN2Yy5nZXRERHhQYXlsb2FkKHRoaXMucGF0aWVudEluZm8sIHRoaXMudmlzaXQsIG5vdGVzKTtcclxuXHJcbiAgICBjb25zdCBhdHRlbXB0RGlhZ25vc2lzID0gKCkgPT4ge1xyXG4gICAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XHJcbiAgICAgIHRoaXMuZGlhZ25vc2lzTGlzdCA9IFtdO1xyXG4gICAgICB0aGlzLmZ1cnRoZXJRdWVzdGlvbnNMaXN0ID0gW107XHJcbiAgICAgIHRoaXMuZGR4U3ZjLmdldEFJRGlhZ25vc2lzKHBheWxvYWQpLnN1YnNjcmliZSh7XHJcbiAgICAgICAgbmV4dDogKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgaWYgKGRhdGE/LmNvbmNsdXNpb24pIHRoaXMuY29uY2x1c2lvbiA9IGRhdGE/LmNvbmNsdXNpb247XHJcbiAgICAgICAgICBpZiAoZGF0YS5yZXN1bHQuZGF0YS5yZXN1bHQubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLm5vRGF0YSA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmRpYWdub3Npc0xpc3QgPSBkYXRhLnJlc3VsdC5kYXRhLnJlc3VsdC5tYXAodiA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC4uLnYsXHJcbiAgICAgICAgICAgICAgICBkaWFnbm9zaXM6IHY/LmRpYWdub3Npcz8ucmVwbGFjZSgvXFxzKlxcKC4qP1xcKVxccyovZywgJycpLFxyXG4gICAgICAgICAgICAgICAgcmF0aW9uYWxlOiB0aGlzLmRkeFN2Yy5tYXJrZG93bml0KHY/LnJhdGlvbmFsZSlcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5ub0RhdGEgPSB0cnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYoZGF0YS5yZXN1bHQuZGF0YS5mdXJ0aGVyX3F1ZXN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZnVydGhlclF1ZXN0aW9uc0xpc3QgPSBkYXRhLnJlc3VsdC5kYXRhLmZ1cnRoZXJfcXVlc3Rpb25zLm1hcChxID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBrZXkgPSBPYmplY3Qua2V5cyhxKVswXTtcclxuICAgICAgICAgICAgICByZXR1cm4gcVtrZXldO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcnJvcjogKGVycjogYW55KSA9PiB7XHJcbiAgICAgICAgICByZXRyeUNvdW50Kys7XHJcbiAgICAgICAgICBpZiAocmV0cnlDb3VudCA8IE1BWF9SRVRSSUVTKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBSZXRyeSBhdHRlbXB0ICR7cmV0cnlDb3VudH0gZm9yIGdldEFJRGlhZ25vc2lzYCk7XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGF0dGVtcHREaWFnbm9zaXMoKTtcclxuICAgICAgICAgICAgfSwgMTAwMCk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGdldCBBSSBkaWFnbm9zaXMgYWZ0ZXIgMyBhdHRlbXB0czonLCBlcnIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29tcGxldGU6ICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgYXR0ZW1wdERpYWdub3NpcygpO1xyXG4gIH1cclxuXHJcbiAgb25UcnlBZ2FpbigpIHtcclxuICAgIHRoaXMuZ2V0QUlEaWFnbm9zaXModGhpcy5ub3Rlcyk7XHJcbiAgfVxyXG5cclxuXHJcbiAgb25BSURpYWdub3Npc0NoYW5nZShldmVudDogYW55KSB7XHJcbiAgICBpZiAoIWV2ZW50KSB7XHJcbiAgICAgIHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMgPSBbXTtcclxuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShldmVudCkpIHtcclxuICAgICAgdGhpcy5zZWxlY3RlZERpYWdub3NpcyA9IFsuLi5ldmVudF07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMuaW5kZXhPZihldmVudCk7XHJcbiAgICAgIGlmIChpbmRleCA+IC0xKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZERpYWdub3NpcyA9IHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMuZmlsdGVyKGQgPT4gZCAhPT0gZXZlbnQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMgPSBbLi4udGhpcy5zZWxlY3RlZERpYWdub3NpcywgZXZlbnRdO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLmRpYWdub3Npc1NlbGVjdGVkLmVtaXQoWy4uLnRoaXMuc2VsZWN0ZWREaWFnbm9zaXNdKTtcclxuICB9XHJcblxyXG4gIGlzRGlhZ25vc2lzRXhpc3RzKGRpYWdub3Npczogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5leGlzdGluZ0RpYWdub3Npcy5zb21lKGQgPT4gZC5kaWFnbm9zaXNOYW1lID09PSBkaWFnbm9zaXMpO1xyXG4gIH1cclxuXHJcbiAgaXNEaWFnbm9zaXNTZWxlY3RlZChkaWFnbm9zaXM6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMuaW5jbHVkZXMoZGlhZ25vc2lzKSB8fCB0aGlzLmV4aXN0aW5nRGlhZ25vc2lzLnNvbWUoZCA9PiBkPy5kaWFnbm9zaXNOYW1lID09PSBkaWFnbm9zaXMpO1xyXG4gIH1cclxufVxyXG4iLCI8bmctY29udGFpbmVyICpuZ0lmPVwiIWRpYWdub3Npc0xpc3QubGVuZ3RoXCI+XHJcbiAgICA8ZGl2IGNsYXNzPVwiZC1mbGV4IGp1c3RpZnktY29udGVudC1jZW50ZXIgbXQtMlwiPlxyXG4gICAgICAgIDxkaXYgY2xhc3M9XCJlcm9yci1jb250YWluZXIgYWxlcnQgdGV4dC1jZW50ZXIgcC00IGQtZmxleCBmbGV4LWNvbHVtbiBhbGlnbi1pdGVtcy1jZW50ZXJcIj5cclxuICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cIiFpc0xvYWRpbmcgJiYgKGhhc0Vycm9yIHx8IG5vRGF0YSlcIj5cclxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJ0ZXh0LWRhbmdlclwiPlxyXG4gICAgICAgICAgICAgICAgICAgIDxpIGNsYXNzPVwiYmkgYmktZXhjbGFtYXRpb24tdHJpYW5nbGUtZmlsbFwiPjwvaT5cclxuICAgICAgICAgICAgICAgICAgICA8aW1nIHNyYz1cImFzc2V0cy9pbWFnZXMvbG9naW4vaW50ZXJuZXRpY29uLnBuZ1wiIGFsdD1cIldhcm5pbmdcIiBjbGFzcz1cIndhcm5pbmctaWNvbiBtci0yXCIgLz5cclxuICAgICAgICAgICAgICAgICAgICA8c3BhbiAqbmdJZj1cImhhc0Vycm9yXCIgY2xhc3M9XCJtcy0yXCI+QW4gdW5leHBlY3RlZCBpc3N1ZSBvY2N1cnJlZDwvc3Bhbj5cclxuICAgICAgICAgICAgICAgICAgICA8c3BhbiAqbmdJZj1cIm5vRGF0YVwiIGNsYXNzPVwibXMtMlwiPlRoZSBpbnB1dCBwcm92aWRlZCBkb2VzIG5vdCBoYXZlIGVub3VnaCBjbGluaWNhbCBkZXRhaWxzIGZvciBhbiBBSS1hc3Npc3RhbnQgYXNzZXNzbWVudC48L3NwYW4+XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgIDxidXR0b24gKm5nSWY9XCIhbm9EYXRhXCIgdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwidHJ5LWFnYWluLWJ0biBtdC0zXCIgKGNsaWNrKT1cIm9uVHJ5QWdhaW4oKVwiPlxyXG4gICAgICAgICAgICAgICAgICAgIHt7J1RyeSBhZ2Fpbid8dHJhbnNsYXRlfX1cclxuICAgICAgICAgICAgICAgIDwvYnV0dG9uPlxyXG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuXHJcbiAgICAgICAgICAgIDxidXR0b24gKm5nSWY9XCJpc0xvYWRpbmdcIiBjbGFzcz1cInN0YXRzLWxvYWRpbmdcIj5cclxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJlaW5zXCI+PC9kaXY+XHJcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwiendlaVwiPjwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImRyZWlcIj48L2Rpdj5cclxuICAgICAgICAgICAgPC9idXR0b24+XHJcblxyXG4gICAgICAgICAgICA8ZGl2ICpuZ0lmPVwiaXNMb2FkaW5nXCIgY2xhc3M9XCJtdC0zXCI+XHJcbiAgICAgICAgICAgICAgICA8aSBjbGFzcz1cImJpIGJpLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlLWZpbGxcIj48L2k+XHJcbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cIm1zLTIgbG9hZGluZy10ZXh0XCI+UGxlYXNlIHdhaXQgd2hpbGUgdGhlIHJlc3VsdHMgYXJlIGJlaW5nIGdlbmVyYXRlZC48L3NwYW4+XHJcbiAgICAgICAgICAgIDwvZGl2PlxyXG5cclxuICAgICAgICA8L2Rpdj5cclxuICAgIDwvZGl2PlxyXG48L25nLWNvbnRhaW5lcj5cclxuXHJcbjxuZy1jb250YWluZXIgKm5nSWY9XCJkaWFnbm9zaXNMaXN0Lmxlbmd0aFwiIGNsYXNzPVwibXQtMlwiPlxyXG4gICAgPHAgY2xhc3M9XCJub3RlLWNvbiBtbC0yXCI+XHJcbiAgICAgICAgPHNwYW4gY2xhc3M9XCJub3RlLWxhYmVsXCI+Tm90ZTo8L3NwYW4+XHJcbiAgICAgICAgVGhpcyBpbmZvcm1hdGlvbiBpcyBBSSBnZW5lcmF0ZWQuIFBsZWFzZSByZWx5IG9uIHlvdXIgbWVkaWNhbCBqdWRnZW1lbnQgd2hpbGUgcmVmZXJyaW5nIHRvIGl0LlxyXG4gICAgPC9wPlxyXG4gICAgPGRpdiBjbGFzcz1cImludGVsLWFjY29yZGlvbi10aXRsZVwiPlxyXG4gICAgICAgIDxoNiBjbGFzcz1cIm10LTEgbWwtMiBkaWZmcmVudGlhbC1kaWFnbm9zaXNcIj5EaWZmZXJlbnRpYWwgRGlhZ25vc2lzPC9oNj5cclxuICAgIDwvZGl2PlxyXG4gICAgPGRpdiBjbGFzcz1cImludGVsLWFjY29yZGlvbi10aXRsZVwiPlxyXG4gICAgICAgIDxwIGNsYXNzPVwidGV4dC1tdXRlZCBtYi0zIGRpYWdub3Npcy1saXN0IG1sLTJcIj5cclxuICAgICAgICAgICAgU2VsZWN0IHRoZSBkaWFnbm9zaXMgYmFzZWQgb24geW91ciBtZWRpY2FsIGp1ZGdlbWVudC5cclxuICAgICAgICA8L3A+XHJcbiAgICA8L2Rpdj5cclxuXHJcbiAgICA8ZGl2IGNsYXNzPVwiZGlhZ25vc2lzLWNvbnRhaW5lciBwLTNcIj5cclxuICAgICAgICA8ZGl2ICpuZ0Zvcj1cImxldCBkaWFnbm9zaXMgb2YgZGlhZ25vc2lzTGlzdFwiIFxyXG4gICAgICAgICAgICAgY2xhc3M9XCJkLWZsZXggYWxpZ24taXRlbXMtY2VudGVyIG1iLTJcIlxyXG4gICAgICAgICAgICAgW2NsYXNzLmRpc2FibGVkLWRpYWdub3Npc109XCJpc0RpYWdub3Npc0V4aXN0cyhkaWFnbm9zaXMuZGlhZ25vc2lzKVwiPlxyXG4gICAgICAgICAgICA8aW5wdXQgdHlwZT1cImNoZWNrYm94XCIgY2xhc3M9XCJjdXN0b20tY2hlY2tib3ggbWUtMlwiXHJcbiAgICAgICAgICAgICAgICBbY2hlY2tlZF09XCJpc0RpYWdub3Npc1NlbGVjdGVkKGRpYWdub3Npcy5kaWFnbm9zaXMpXCJcclxuICAgICAgICAgICAgICAgIFtkaXNhYmxlZF09XCJpc0RpYWdub3Npc0V4aXN0cyhkaWFnbm9zaXMuZGlhZ25vc2lzKVwiXHJcbiAgICAgICAgICAgICAgICAoY2hhbmdlKT1cIm9uQUlEaWFnbm9zaXNDaGFuZ2UoZGlhZ25vc2lzLmRpYWdub3NpcylcIj5cclxuICAgICAgICAgICAgPGxhYmVsIGNsYXNzPVwiZnctYm9sZFwiIFtjbGFzcy50ZXh0LW11dGVkXT1cImlzRGlhZ25vc2lzRXhpc3RzKGRpYWdub3Npcy5kaWFnbm9zaXMpXCI+XHJcbiAgICAgICAgICAgICAgICB7eyBkaWFnbm9zaXMuZGlhZ25vc2lzIH19XHJcbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cInRleHQtbXV0ZWQgbXMtMlwiPihsaWtlbHkge3sgZGlhZ25vc2lzLmxpa2VsaWhvb2QgfX0pPC9zcGFuPlxyXG4gICAgICAgICAgICA8L2xhYmVsPlxyXG4gICAgICAgIDwvZGl2PlxyXG4gICAgPC9kaXY+XHJcblxyXG4gICAgPGRpdiBjbGFzcz1cInJhdGlvbmFsZS1jb250YWluZXJcIj5cclxuICAgICAgICA8aDUgY2xhc3M9XCJmdy1ib2xkIHJhdGlvbmFsZVwiPlJhdGlvbmFsZTwvaDU+XHJcbiAgICAgICAgPGRpdiAqbmdGb3I9XCJsZXQgcmF0aW9uYWxlIG9mIGRpYWdub3Npc0xpc3Q7IGxldCBpID0gaW5kZXhcIiBjbGFzcz1cInJhdGlvbmFsZS1pdGVtIHAtMyBtYi0yXCI+XHJcbiAgICAgICAgICAgIDxoMyBjbGFzcz1cImZ3LWJvbGRcIj5cclxuICAgICAgICAgICAgICAgIHt7IGkgKyAxIH19LiB7eyByYXRpb25hbGUuZGlhZ25vc2lzIH19XHJcbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cInRleHQtbXV0ZWQgc21hbGxcIj4obGlrZWx5IHt7IHJhdGlvbmFsZS5saWtlbGlob29kIH19KTwvc3Bhbj5cclxuICAgICAgICAgICAgPC9oMz5cclxuICAgICAgICAgICAgPHAgY2xhc3M9XCJyYXRpb25hbGUtZGVzY3JpcHRpb25cIiBbaW5uZXJIVE1MXT1cInJhdGlvbmFsZS5yYXRpb25hbGVcIj48L3A+XHJcbiAgICAgICAgPC9kaXY+XHJcbiAgICA8L2Rpdj5cclxuXHJcbjwvbmctY29udGFpbmVyPlxyXG5cclxuPGRpdiAqbmdJZj1cImNvbmNsdXNpb25cIiBjbGFzcz1cImNvbmNsdXNpb24tY2FyZFwiPlxyXG4gICAgPGRpdiBjbGFzcz1cImNvbmNsdXNpb24taGVhZGVyXCI+XHJcbiAgICAgICAgPGgyPkNvbmNsdXNpb248L2gyPlxyXG4gICAgPC9kaXY+XHJcbiAgICA8ZGl2IGNsYXNzPVwiY29uY2x1c2lvbi1ib2R5XCI+XHJcbiAgICAgICAgPHA+e3sgY29uY2x1c2lvbiB9fTwvcD5cclxuICAgIDwvZGl2PlxyXG48L2Rpdj5cclxuXHJcbjxkaXYgKm5nSWY9XCJmdXJ0aGVyUXVlc3Rpb25zTGlzdC5sZW5ndGhcIiBjbGFzcz1cInJhdGlvbmFsZS1jb250YWluZXJcIj5cclxuICAgIDxoMiBjbGFzcz1cImZ3LWJvbGRcIj5GdXJ0aGVyIHF1ZXN0aW9uczwvaDI+XHJcbiAgICA8ZGl2ICpuZ0Zvcj1cImxldCBxdWVzdGlvbiBvZiBmdXJ0aGVyUXVlc3Rpb25zTGlzdDsgbGV0IGkgPSBpbmRleFwiIGNsYXNzPVwiZnEtaXRlbVwiPlxyXG4gICAgICAgIDxsaT57eyBxdWVzdGlvbiB9fTwvbGk+XHJcbiAgICA8L2Rpdj5cclxuPC9kaXY+Il19
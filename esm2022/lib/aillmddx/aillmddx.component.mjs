import { Component, Input, Output, EventEmitter } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../../services/aiddx.service";
import * as i2 from "@angular/common";
import * as i3 from "@ngx-translate/core";
// import { dummyPayload, response } from '../token';
export class AillmddxComponent {
    ddxSvc;
    patientInfo;
    visit;
    existingDiagnosis = [];
    diagnosisSelected = new EventEmitter();
    notes;
    isLoading = false;
    hasError = false;
    noData = false;
    insufficientData = false;
    conclusion = '';
    questions = [
        {
            title: 'Key symptoms and their characteristics',
            items: [
                'Can you describe the rash in more detail?',
                'Are there any blackheads or whiteheads?',
                'Does the rash itch or burn? Does it get worse after sweating or sun exposure?',
                'When you say the rash is transient, how long does it last before disappearing?',
                'Does it reappear in the same location?'
            ]
        },
    ];
    diagnosisList = [];
    selectedDiagnosis = [];
    constructor(ddxSvc) {
        this.ddxSvc = ddxSvc;
    }
    ngOnInit() { }
    getAIDiagnosis(notes) {
        const payload = this.ddxSvc.getDDxPayload(this.patientInfo, this.visit, notes);
        this.isLoading = true;
        this.diagnosisList = [];
        this.ddxSvc.getAIDiagnosis(payload).subscribe({
            next: (data) => {
                if (data?.conclusion)
                    this.conclusion = data?.conclusion;
                if (data.result.length > 0) {
                    this.noData = false;
                    this.diagnosisList = data.result.map(v => {
                        return {
                            ...v,
                            diagnosis: v?.diagnosis?.replace(/\s*\(.*?\)\s*/g, ''),
                            rationale: this.ddxSvc.markdownit(v?.rationale)
                        };
                    });
                }
                else {
                    this.noData = true;
                }
            },
            error: (err) => {
                this.hasError = true;
                this.isLoading = false;
            },
            complete: () => {
                this.isLoading = false;
            }
        });
        // setTimeout(() => {
        //   if (response.result.length > 0) {
        //     this.noData = false;
        //     this.conclusion = response?.conclusion;
        //     this.diagnosisList = response.result.map(v => ({ ...v, diagnosis: v?.diagnosis?.replace(/\s*\(.*?\)\s*/g, '') }));
        //   } else {
        //     this.noData = true;
        //   }
        //   this.isLoading = false;
        // }, 3000);
    }
    getAIDiagnosisWithRetry(notes) {
        const MAX_RETRIES = 3;
        let retryCount = 0;
        const payload = this.ddxSvc.getDDxPayload(this.patientInfo, this.visit, notes);
        const attemptDiagnosis = () => {
            this.isLoading = true;
            this.diagnosisList = [];
            this.ddxSvc.getAIDiagnosis(payload).subscribe({
                next: (data) => {
                    if (data?.conclusion)
                        this.conclusion = data?.conclusion;
                    if (data.result.length > 0) {
                        this.noData = false;
                        this.diagnosisList = data.result.map(v => {
                            return {
                                ...v,
                                diagnosis: v?.diagnosis?.replace(/\s*\(.*?\)\s*/g, ''),
                                rationale: this.ddxSvc.markdownit(v?.rationale)
                            };
                        });
                    }
                    else {
                        this.noData = true;
                    }
                    this.isLoading = false;
                },
                error: (err) => {
                    retryCount++;
                    if (retryCount < MAX_RETRIES) {
                        console.log(`Retry attempt ${retryCount} for getAIDiagnosis`);
                        setTimeout(() => {
                            attemptDiagnosis();
                        }, 1000);
                    }
                    else {
                        this.hasError = true;
                        this.isLoading = false;
                        console.error('Failed to get AI diagnosis after 3 attempts:', err);
                    }
                },
                complete: () => {
                    this.isLoading = false;
                }
            });
        };
        attemptDiagnosis();
    }
    onTryAgain() {
        this.getAIDiagnosis(this.notes);
    }
    onAIDiagnosisChange(event) {
        if (!event) {
            this.selectedDiagnosis = [];
        }
        else if (Array.isArray(event)) {
            this.selectedDiagnosis = [...event];
        }
        else {
            const index = this.selectedDiagnosis.indexOf(event);
            if (index > -1) {
                this.selectedDiagnosis = this.selectedDiagnosis.filter(d => d !== event);
            }
            else {
                this.selectedDiagnosis = [...this.selectedDiagnosis, event];
            }
        }
        this.diagnosisSelected.emit([...this.selectedDiagnosis]);
    }
    isDiagnosisExists(diagnosis) {
        return this.existingDiagnosis.some(d => d.diagnosisName === diagnosis);
    }
    isDiagnosisSelected(diagnosis) {
        return this.selectedDiagnosis.includes(diagnosis) || this.existingDiagnosis.some(d => d?.diagnosisName === diagnosis);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AillmddxComponent, deps: [{ token: i1.AiddxService }], target: i0.ɵɵFactoryTarget.Component });
    static ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.3.0", type: AillmddxComponent, selector: "app-aillmddx", inputs: { patientInfo: "patientInfo", visit: "visit", existingDiagnosis: "existingDiagnosis", notes: "notes" }, outputs: { diagnosisSelected: "diagnosisSelected" }, ngImport: i0, template: "<ng-container *ngIf=\"!diagnosisList.length\">\n    <div class=\"d-flex justify-content-center mt-2\">\n        <div class=\"erorr-container alert text-center p-4 d-flex flex-column align-items-center\">\n            <ng-container *ngIf=\"!isLoading && (hasError || noData)\">\n                <div class=\"text-danger\">\n                    <i class=\"bi bi-exclamation-triangle-fill\"></i>\n                    <img src=\"assets/images/login/interneticon.png\" alt=\"Warning\" class=\"warning-icon mr-2\" />\n                    <span *ngIf=\"hasError\" class=\"ms-2\">An unexpected issue occurred</span>\n                    <span *ngIf=\"noData\" class=\"ms-2\">The input provided does not have enough clinical details for an AI-assistant assessment.</span>\n                </div>\n                <button *ngIf=\"!noData\" type=\"button\" class=\"try-again-btn mt-3\" (click)=\"onTryAgain()\">\n                    {{'Try again'|translate}}\n                </button>\n            </ng-container>\n\n            <button *ngIf=\"isLoading\" class=\"stats-loading\">\n                <div class=\"eins\"></div>\n                <div class=\"zwei\"></div>\n                <div class=\"drei\"></div>\n            </button>\n\n            <div *ngIf=\"isLoading\" class=\"mt-3\">\n                <i class=\"bi bi-exclamation-triangle-fill\"></i>\n                <span class=\"ms-2 loading-text\">Please wait while the results are being generated.</span>\n            </div>\n\n        </div>\n    </div>\n</ng-container>\n\n<ng-container *ngIf=\"diagnosisList.length\" class=\"mt-2\">\n    <p class=\"note-con ml-2\">\n        <span class=\"note-label\">Note:</span>\n        This information is AI generated. Please rely on your medical judgement while referring to it.\n    </p>\n    <div class=\"intel-accordion-title\">\n        <h6 class=\"mt-1 ml-2 diffrential-diagnosis\">Differential Diagnosis</h6>\n    </div>\n    <div class=\"intel-accordion-title\">\n        <p class=\"text-muted mb-3 diagnosis-list ml-2\">\n            Select the diagnosis based on your medical judgement.\n        </p>\n    </div>\n\n    <div class=\"diagnosis-container p-3\">\n        <div *ngFor=\"let diagnosis of diagnosisList\" \n             class=\"d-flex align-items-center mb-2\"\n             [class.disabled-diagnosis]=\"isDiagnosisExists(diagnosis.diagnosis)\">\n            <input type=\"checkbox\" class=\"custom-checkbox me-2\"\n                [checked]=\"isDiagnosisSelected(diagnosis.diagnosis)\"\n                [disabled]=\"isDiagnosisExists(diagnosis.diagnosis)\"\n                (change)=\"onAIDiagnosisChange(diagnosis.diagnosis)\">\n            <label class=\"fw-bold\" [class.text-muted]=\"isDiagnosisExists(diagnosis.diagnosis)\">\n                {{ diagnosis.diagnosis }}\n                <span class=\"text-muted ms-2\">(likely {{ diagnosis.likelihood }})</span>\n            </label>\n        </div>\n    </div>\n\n    <div class=\"rationale-container\">\n        <h5 class=\"fw-bold rationale\">Rationale</h5>\n        <div *ngFor=\"let rationale of diagnosisList; let i = index\" class=\"rationale-item p-3 mb-2\">\n            <h3 class=\"fw-bold\">\n                {{ i + 1 }}. {{ rationale.diagnosis }}\n                <span class=\"text-muted small\">(likely {{ rationale.likelihood }})</span>\n            </h3>\n            <p class=\"rationale-description\" [innerHTML]=\"rationale.rationale\"></p>\n        </div>\n    </div>\n\n</ng-container>\n\n<div *ngIf=\"conclusion\" class=\"conclusion-card\">\n    <div class=\"conclusion-header\">\n        <h2>Conclusion</h2>\n    </div>\n    <div class=\"conclusion-body\">\n        <p>{{ conclusion }}</p>\n    </div>\n</div>\n\n<!-- <div>\n    <h6 class=\"fw-bold\">Further questions</h6>\n    <div *ngFor=\"let question of questions; let i = index\" class=\"rationale-item p-3 mb-3\">\n        <h6 class=\"fw-bold\">{{ i + 1 }}. {{ question.title }}</h6>\n        <ul>\n            <li *ngFor=\"let item of question.items\">{{ item }}</li>\n        </ul>\n    </div>\n</div> -->", styles: ["@charset \"UTF-8\";.try-again-btn{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.diffrential-diagnosis{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.diagnosis-list{font-weight:400;font-size:14px;line-height:21px;letter-spacing:0%}.diagnosis-container{background-color:#faf7fc;border-radius:10px;padding:15px}.custom-checkbox{appearance:none;width:18px;height:18px;border:1px solid #B0ADBE;border-radius:4px;position:relative;cursor:pointer;background-color:transparent;margin-right:10px;margin-bottom:9px}.custom-checkbox:checked{background-color:#0fd197}.custom-checkbox:checked:after{content:\"\\2713\";font-size:14px;font-weight:700;color:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.rationale-container{background-color:#faf7fc;border-radius:10px;padding:15px}.rationale-item{border-bottom:1.5px solid rgba(178,175,190,.2)}.rationale{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.rationale-description{font-weight:400;font-size:16px;line-height:24px;letter-spacing:0%;margin-left:13px}.stats-loading{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.stats-loading div{background:#0060ff;display:inline-block;height:8px;width:8px;border-radius:100%;animation:bouncedelay 1.4s infinite ease-in-out;animation-fill-mode:both}.stats-loading div.eins{animation-delay:-.32s}.stats-loading div.zwei{animation-delay:-.16s}@keyframes bouncedelay{0%,80%,to{transform:scale(0);opacity:0}40%{transform:scale(1);opacity:100}}.loading-text{font-weight:400;font-size:12px;line-height:18px;color:#7f7b92}.conclusion-card{background:#fff;border-radius:10px;margin:20px 0;box-shadow:0 1px 3px #1018281a,0 1px 2px #1018280f}.conclusion-card .conclusion-header{padding:16px 24px;border-bottom:1px solid #EAECF0}.conclusion-card .conclusion-header h2{font-size:16px;font-weight:700;line-height:24px;margin:0;color:#101828}.conclusion-card .conclusion-body{padding:24px}.conclusion-card .conclusion-body p{margin:0;font-size:14px;line-height:20px;color:#344054;font-weight:400}.note-con{background:#f8f9fa;border-radius:4px;padding:12px 16px;margin:16px 0;font-size:14px;line-height:20px;color:#212529}.note-con .note-label{font-weight:600;margin-right:4px;color:#dc3545}.disabled-diagnosis{opacity:.7;cursor:not-allowed}.disabled-diagnosis .custom-checkbox{cursor:not-allowed}.disabled-diagnosis .text-muted{opacity:.7}.warning-icon{height:50px;width:50px}.erorr-container{height:150px;background-color:#faf7fc;border-radius:10px;width:100%}\n"], dependencies: [{ kind: "directive", type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "pipe", type: i3.TranslatePipe, name: "translate" }] });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AillmddxComponent, decorators: [{
            type: Component,
            args: [{ selector: 'app-aillmddx', template: "<ng-container *ngIf=\"!diagnosisList.length\">\n    <div class=\"d-flex justify-content-center mt-2\">\n        <div class=\"erorr-container alert text-center p-4 d-flex flex-column align-items-center\">\n            <ng-container *ngIf=\"!isLoading && (hasError || noData)\">\n                <div class=\"text-danger\">\n                    <i class=\"bi bi-exclamation-triangle-fill\"></i>\n                    <img src=\"assets/images/login/interneticon.png\" alt=\"Warning\" class=\"warning-icon mr-2\" />\n                    <span *ngIf=\"hasError\" class=\"ms-2\">An unexpected issue occurred</span>\n                    <span *ngIf=\"noData\" class=\"ms-2\">The input provided does not have enough clinical details for an AI-assistant assessment.</span>\n                </div>\n                <button *ngIf=\"!noData\" type=\"button\" class=\"try-again-btn mt-3\" (click)=\"onTryAgain()\">\n                    {{'Try again'|translate}}\n                </button>\n            </ng-container>\n\n            <button *ngIf=\"isLoading\" class=\"stats-loading\">\n                <div class=\"eins\"></div>\n                <div class=\"zwei\"></div>\n                <div class=\"drei\"></div>\n            </button>\n\n            <div *ngIf=\"isLoading\" class=\"mt-3\">\n                <i class=\"bi bi-exclamation-triangle-fill\"></i>\n                <span class=\"ms-2 loading-text\">Please wait while the results are being generated.</span>\n            </div>\n\n        </div>\n    </div>\n</ng-container>\n\n<ng-container *ngIf=\"diagnosisList.length\" class=\"mt-2\">\n    <p class=\"note-con ml-2\">\n        <span class=\"note-label\">Note:</span>\n        This information is AI generated. Please rely on your medical judgement while referring to it.\n    </p>\n    <div class=\"intel-accordion-title\">\n        <h6 class=\"mt-1 ml-2 diffrential-diagnosis\">Differential Diagnosis</h6>\n    </div>\n    <div class=\"intel-accordion-title\">\n        <p class=\"text-muted mb-3 diagnosis-list ml-2\">\n            Select the diagnosis based on your medical judgement.\n        </p>\n    </div>\n\n    <div class=\"diagnosis-container p-3\">\n        <div *ngFor=\"let diagnosis of diagnosisList\" \n             class=\"d-flex align-items-center mb-2\"\n             [class.disabled-diagnosis]=\"isDiagnosisExists(diagnosis.diagnosis)\">\n            <input type=\"checkbox\" class=\"custom-checkbox me-2\"\n                [checked]=\"isDiagnosisSelected(diagnosis.diagnosis)\"\n                [disabled]=\"isDiagnosisExists(diagnosis.diagnosis)\"\n                (change)=\"onAIDiagnosisChange(diagnosis.diagnosis)\">\n            <label class=\"fw-bold\" [class.text-muted]=\"isDiagnosisExists(diagnosis.diagnosis)\">\n                {{ diagnosis.diagnosis }}\n                <span class=\"text-muted ms-2\">(likely {{ diagnosis.likelihood }})</span>\n            </label>\n        </div>\n    </div>\n\n    <div class=\"rationale-container\">\n        <h5 class=\"fw-bold rationale\">Rationale</h5>\n        <div *ngFor=\"let rationale of diagnosisList; let i = index\" class=\"rationale-item p-3 mb-2\">\n            <h3 class=\"fw-bold\">\n                {{ i + 1 }}. {{ rationale.diagnosis }}\n                <span class=\"text-muted small\">(likely {{ rationale.likelihood }})</span>\n            </h3>\n            <p class=\"rationale-description\" [innerHTML]=\"rationale.rationale\"></p>\n        </div>\n    </div>\n\n</ng-container>\n\n<div *ngIf=\"conclusion\" class=\"conclusion-card\">\n    <div class=\"conclusion-header\">\n        <h2>Conclusion</h2>\n    </div>\n    <div class=\"conclusion-body\">\n        <p>{{ conclusion }}</p>\n    </div>\n</div>\n\n<!-- <div>\n    <h6 class=\"fw-bold\">Further questions</h6>\n    <div *ngFor=\"let question of questions; let i = index\" class=\"rationale-item p-3 mb-3\">\n        <h6 class=\"fw-bold\">{{ i + 1 }}. {{ question.title }}</h6>\n        <ul>\n            <li *ngFor=\"let item of question.items\">{{ item }}</li>\n        </ul>\n    </div>\n</div> -->", styles: ["@charset \"UTF-8\";.try-again-btn{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.diffrential-diagnosis{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.diagnosis-list{font-weight:400;font-size:14px;line-height:21px;letter-spacing:0%}.diagnosis-container{background-color:#faf7fc;border-radius:10px;padding:15px}.custom-checkbox{appearance:none;width:18px;height:18px;border:1px solid #B0ADBE;border-radius:4px;position:relative;cursor:pointer;background-color:transparent;margin-right:10px;margin-bottom:9px}.custom-checkbox:checked{background-color:#0fd197}.custom-checkbox:checked:after{content:\"\\2713\";font-size:14px;font-weight:700;color:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.rationale-container{background-color:#faf7fc;border-radius:10px;padding:15px}.rationale-item{border-bottom:1.5px solid rgba(178,175,190,.2)}.rationale{font-weight:700;font-size:16px;line-height:24px;letter-spacing:0%}.rationale-description{font-weight:400;font-size:16px;line-height:24px;letter-spacing:0%;margin-left:13px}.stats-loading{padding:6px 24px;background:var(--color-lightGray);border-radius:8px;border:none;outline:none;font-family:DM Sans;font-weight:700;font-size:14px;line-height:150%;color:var(--color-darkBlue)}.stats-loading div{background:#0060ff;display:inline-block;height:8px;width:8px;border-radius:100%;animation:bouncedelay 1.4s infinite ease-in-out;animation-fill-mode:both}.stats-loading div.eins{animation-delay:-.32s}.stats-loading div.zwei{animation-delay:-.16s}@keyframes bouncedelay{0%,80%,to{transform:scale(0);opacity:0}40%{transform:scale(1);opacity:100}}.loading-text{font-weight:400;font-size:12px;line-height:18px;color:#7f7b92}.conclusion-card{background:#fff;border-radius:10px;margin:20px 0;box-shadow:0 1px 3px #1018281a,0 1px 2px #1018280f}.conclusion-card .conclusion-header{padding:16px 24px;border-bottom:1px solid #EAECF0}.conclusion-card .conclusion-header h2{font-size:16px;font-weight:700;line-height:24px;margin:0;color:#101828}.conclusion-card .conclusion-body{padding:24px}.conclusion-card .conclusion-body p{margin:0;font-size:14px;line-height:20px;color:#344054;font-weight:400}.note-con{background:#f8f9fa;border-radius:4px;padding:12px 16px;margin:16px 0;font-size:14px;line-height:20px;color:#212529}.note-con .note-label{font-weight:600;margin-right:4px;color:#dc3545}.disabled-diagnosis{opacity:.7;cursor:not-allowed}.disabled-diagnosis .custom-checkbox{cursor:not-allowed}.disabled-diagnosis .text-muted{opacity:.7}.warning-icon{height:50px;width:50px}.erorr-container{height:150px;background-color:#faf7fc;border-radius:10px;width:100%}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.AiddxService }]; }, propDecorators: { patientInfo: [{
                type: Input
            }], visit: [{
                type: Input
            }], existingDiagnosis: [{
                type: Input
            }], diagnosisSelected: [{
                type: Output
            }], notes: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlsbG1kZHguY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYWlkZHgtbGlicmFyeS9zcmMvbGliL2FpbGxtZGR4L2FpbGxtZGR4LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FpZGR4LWxpYnJhcnkvc3JjL2xpYi9haWxsbWRkeC9haWxsbWRkeC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7OztBQUV2RSxxREFBcUQ7QUFPckQsTUFBTSxPQUFPLGlCQUFpQjtJQTJCbEI7SUExQkQsV0FBVyxDQUFNO0lBQ2pCLEtBQUssQ0FBTTtJQUNYLGlCQUFpQixHQUFVLEVBQUUsQ0FBQztJQUM3QixpQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBWSxDQUFDO0lBQ2xELEtBQUssQ0FBUztJQUN2QixTQUFTLEdBQUcsS0FBSyxDQUFDO0lBQ2xCLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFDakIsTUFBTSxHQUFHLEtBQUssQ0FBQztJQUNmLGdCQUFnQixHQUFHLEtBQUssQ0FBQztJQUN6QixVQUFVLEdBQVcsRUFBRSxDQUFDO0lBQ3hCLFNBQVMsR0FBRztRQUNWO1lBQ0UsS0FBSyxFQUFFLHdDQUF3QztZQUMvQyxLQUFLLEVBQUU7Z0JBQ0wsMkNBQTJDO2dCQUMzQyx5Q0FBeUM7Z0JBQ3pDLCtFQUErRTtnQkFDL0UsZ0ZBQWdGO2dCQUNoRix3Q0FBd0M7YUFDekM7U0FDRjtLQUNGLENBQUM7SUFDRixhQUFhLEdBQVEsRUFBRSxDQUFBO0lBQ3ZCLGlCQUFpQixHQUFhLEVBQUUsQ0FBQztJQUVqQyxZQUNVLE1BQW9CO1FBQXBCLFdBQU0sR0FBTixNQUFNLENBQWM7SUFDMUIsQ0FBQztJQUVMLFFBQVEsS0FBSSxDQUFDO0lBRU4sY0FB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aUI7a0JBTDdCLFNBQVM7K0JBQ0UsY0FBYzttR0FLZixXQUFXO3NCQUFuQixLQUFLO2dCQUNHLEtBQUs7c0JBQWIsS0FBSztnQkFDRyxpQkFBaUI7c0JBQXpCLEtBQUs7Z0JBQ0ksaUJBQWlCO3NCQUExQixNQUFNO2dCQUNFLEtBQUs7c0JBQWIsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBaWRkeFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9haWRkeC5zZXJ2aWNlJztcbi8vIGltcG9ydCB7IGR1bW15UGF5bG9hZCwgcmVzcG9uc2UgfSBmcm9tICcuLi90b2tlbic7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2FwcC1haWxsbWRkeCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9haWxsbWRkeC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2FpbGxtZGR4LmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgQWlsbG1kZHhDb21wb25lbnQge1xuICBASW5wdXQoKSBwYXRpZW50SW5mbzogYW55O1xuICBASW5wdXQoKSB2aXNpdDogYW55O1xuICBASW5wdXQoKSBleGlzdGluZ0RpYWdub3NpczogYW55W10gPSBbXTtcbiAgQE91dHB1dCgpIGRpYWdub3Npc1NlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmdbXT4oKTtcbiAgQElucHV0KCkgbm90ZXM6IHN0cmluZztcbiAgaXNMb2FkaW5nID0gZmFsc2U7XG4gIGhhc0Vycm9yID0gZmFsc2U7XG4gIG5vRGF0YSA9IGZhbHNlO1xuICBpbnN1ZmZpY2llbnREYXRhID0gZmFsc2U7XG4gIGNvbmNsdXNpb246IHN0cmluZyA9ICcnO1xuICBxdWVzdGlvbnMgPSBbXG4gICAge1xuICAgICAgdGl0bGU6ICdLZXkgc3ltcHRvbXMgYW5kIHRoZWlyIGNoYXJhY3RlcmlzdGljcycsXG4gICAgICBpdGVtczogW1xuICAgICAgICAnQ2FuIHlvdSBkZXNjcmliZSB0aGUgcmFzaCBpbiBtb3JlIGRldGFpbD8nLFxuICAgICAgICAnQXJlIHRoZXJlIGFueSBibGFja2hlYWRzIG9yIHdoaXRlaGVhZHM/JyxcbiAgICAgICAgJ0RvZXMgdGhlIHJhc2ggaXRjaCBvciBidXJuPyBEb2VzIGl0IGdldCB3b3JzZSBhZnRlciBzd2VhdGluZyBvciBzdW4gZXhwb3N1cmU/JyxcbiAgICAgICAgJ1doZW4geW91IHNheSB0aGUgcmFzaCBpcyB0cmFuc2llbnQsIGhvdyBsb25nIGRvZXMgaXQgbGFzdCBiZWZvcmUgZGlzYXBwZWFyaW5nPycsXG4gICAgICAgICdEb2VzIGl0IHJlYXBwZWFyIGluIHRoZSBzYW1lIGxvY2F0aW9uPydcbiAgICAgIF1cbiAgICB9LFxuICBdO1xuICBkaWFnbm9zaXNMaXN0OiBhbnkgPSBbXVxuICBzZWxlY3RlZERpYWdub3Npczogc3RyaW5nW10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGRkeFN2YzogQWlkZHhTZXJ2aWNlLFxuICApIHsgfVxuXG4gIG5nT25Jbml0KCkge31cblxuICBwdWJsaWMgZ2V0QUlEaWFnbm9zaXMobm90ZXM/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5kZHhTdmMuZ2V0RER4UGF5bG9hZCh0aGlzLnBhdGllbnRJbmZvLCB0aGlzLnZpc2l0LCBub3Rlcyk7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgIHRoaXMuZGlhZ25vc2lzTGlzdCA9IFtdO1xuICAgIHRoaXMuZGR4U3ZjLmdldEFJRGlhZ25vc2lzKHBheWxvYWQpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAoZGF0YTogYW55KSA9PiB7XG4gICAgICAgIGlmIChkYXRhPy5jb25jbHVzaW9uKSB0aGlzLmNvbmNsdXNpb24gPSBkYXRhPy5jb25jbHVzaW9uO1xuICAgICAgICBpZiAoZGF0YS5yZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMubm9EYXRhID0gZmFsc2U7XG4gICAgICAgICAgdGhpcy5kaWFnbm9zaXNMaXN0ID0gZGF0YS5yZXN1bHQubWFwKHYgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgLi4udixcbiAgICAgICAgICAgICAgZGlhZ25vc2lzOiB2Py5kaWFnbm9zaXM/LnJlcGxhY2UoL1xccypcXCguKj9cXClcXHMqL2csICcnKSxcbiAgICAgICAgICAgICAgcmF0aW9uYWxlOiB0aGlzLmRkeFN2Yy5tYXJrZG93bml0KHY/LnJhdGlvbmFsZSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLm5vRGF0YSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBlcnJvcjogKGVycjogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuaGFzRXJyb3IgPSB0cnVlO1xuICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgfSxcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAvLyAgIGlmIChyZXNwb25zZS5yZXN1bHQubGVuZ3RoID4gMCkge1xuICAgIC8vICAgICB0aGlzLm5vRGF0YSA9IGZhbHNlO1xuICAgIC8vICAgICB0aGlzLmNvbmNsdXNpb24gPSByZXNwb25zZT8uY29uY2x1c2lvbjtcbiAgICAvLyAgICAgdGhpcy5kaWFnbm9zaXNMaXN0ID0gcmVzcG9uc2UucmVzdWx0Lm1hcCh2ID0+ICh7IC4uLnYsIGRpYWdub3Npczogdj8uZGlhZ25vc2lzPy5yZXBsYWNlKC9cXHMqXFwoLio/XFwpXFxzKi9nLCAnJykgfSkpO1xuICAgIC8vICAgfSBlbHNlIHtcbiAgICAvLyAgICAgdGhpcy5ub0RhdGEgPSB0cnVlO1xuICAgIC8vICAgfVxuICAgIC8vICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAvLyB9LCAzMDAwKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRBSURpYWdub3Npc1dpdGhSZXRyeShub3Rlcz86IHN0cmluZykge1xuICAgIGNvbnN0IE1BWF9SRVRSSUVTID0gMztcbiAgICBsZXQgcmV0cnlDb3VudCA9IDA7XG4gICAgY29uc3QgcGF5bG9hZCA9IHRoaXMuZGR4U3ZjLmdldEREeFBheWxvYWQodGhpcy5wYXRpZW50SW5mbywgdGhpcy52aXNpdCwgbm90ZXMpO1xuXG4gICAgY29uc3QgYXR0ZW1wdERpYWdub3NpcyA9ICgpID0+IHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgIHRoaXMuZGlhZ25vc2lzTGlzdCA9IFtdO1xuXG4gICAgICB0aGlzLmRkeFN2Yy5nZXRBSURpYWdub3NpcyhwYXlsb2FkKS5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKGRhdGE/LmNvbmNsdXNpb24pIHRoaXMuY29uY2x1c2lvbiA9IGRhdGE/LmNvbmNsdXNpb247XG4gICAgICAgICAgaWYgKGRhdGEucmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMubm9EYXRhID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmRpYWdub3Npc0xpc3QgPSBkYXRhLnJlc3VsdC5tYXAodiA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4udixcbiAgICAgICAgICAgICAgICBkaWFnbm9zaXM6IHY/LmRpYWdub3Npcz8ucmVwbGFjZSgvXFxzKlxcKC4qP1xcKVxccyovZywgJycpLFxuICAgICAgICAgICAgICAgIHJhdGlvbmFsZTogdGhpcy5kZHhTdmMubWFya2Rvd25pdCh2Py5yYXRpb25hbGUpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm5vRGF0YSA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiAoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgICByZXRyeUNvdW50Kys7XG4gICAgICAgICAgaWYgKHJldHJ5Q291bnQgPCBNQVhfUkVUUklFUykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFJldHJ5IGF0dGVtcHQgJHtyZXRyeUNvdW50fSBmb3IgZ2V0QUlEaWFnbm9zaXNgKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICBhdHRlbXB0RGlhZ25vc2lzKCk7XG4gICAgICAgICAgICB9LCAxMDAwKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5oYXNFcnJvciA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGdldCBBSSBkaWFnbm9zaXMgYWZ0ZXIgMyBhdHRlbXB0czonLCBlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgYXR0ZW1wdERpYWdub3NpcygpO1xuICB9XG5cbiAgb25UcnlBZ2FpbigpIHtcbiAgICB0aGlzLmdldEFJRGlhZ25vc2lzKHRoaXMubm90ZXMpO1xuICB9XG5cblxuICBvbkFJRGlhZ25vc2lzQ2hhbmdlKGV2ZW50OiBhbnkpIHtcbiAgICBpZiAoIWV2ZW50KSB7XG4gICAgICB0aGlzLnNlbGVjdGVkRGlhZ25vc2lzID0gW107XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGV2ZW50KSkge1xuICAgICAgdGhpcy5zZWxlY3RlZERpYWdub3NpcyA9IFsuLi5ldmVudF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zZWxlY3RlZERpYWdub3Npcy5pbmRleE9mKGV2ZW50KTtcbiAgICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMgPSB0aGlzLnNlbGVjdGVkRGlhZ25vc2lzLmZpbHRlcihkID0+IGQgIT09IGV2ZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWREaWFnbm9zaXMgPSBbLi4udGhpcy5zZWxlY3RlZERpYWdub3NpcywgZXZlbnRdO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRpYWdub3Npc1NlbGVjdGVkLmVtaXQoWy4uLnRoaXMuc2VsZWN0ZWREaWFnbm9zaXNdKTtcbiAgfVxuXG4gIGlzRGlhZ25vc2lzRXhpc3RzKGRpYWdub3Npczogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZXhpc3RpbmdEaWFnbm9zaXMuc29tZShkID0+IGQuZGlhZ25vc2lzTmFtZSA9PT0gZGlhZ25vc2lzKTtcbiAgfVxuXG4gIGlzRGlhZ25vc2lzU2VsZWN0ZWQoZGlhZ25vc2lzOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RlZERpYWdub3Npcy5pbmNsdWRlcyhkaWFnbm9zaXMpIHx8IHRoaXMuZXhpc3RpbmdEaWFnbm9zaXMuc29tZShkID0+IGQ/LmRpYWdub3Npc05hbWUgPT09IGRpYWdub3Npcyk7XG4gIH1cbn1cbiIsIjxuZy1jb250YWluZXIgKm5nSWY9XCIhZGlhZ25vc2lzTGlzdC5sZW5ndGhcIj5cbiAgICA8ZGl2IGNsYXNzPVwiZC1mbGV4IGp1c3RpZnktY29udGVudC1jZW50ZXIgbXQtMlwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwiZXJvcnItY29udGFpbmVyIGFsZXJ0IHRleHQtY2VudGVyIHAtNCBkLWZsZXggZmxleC1jb2x1bW4gYWxpZ24taXRlbXMtY2VudGVyXCI+XG4gICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiIWlzTG9hZGluZyAmJiAoaGFzRXJyb3IgfHwgbm9EYXRhKVwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJ0ZXh0LWRhbmdlclwiPlxuICAgICAgICAgICAgICAgICAgICA8aSBjbGFzcz1cImJpIGJpLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlLWZpbGxcIj48L2k+XG4gICAgICAgICAgICAgICAgICAgIDxpbWcgc3JjPVwiYXNzZXRzL2ltYWdlcy9sb2dpbi9pbnRlcm5ldGljb24ucG5nXCIgYWx0PVwiV2FybmluZ1wiIGNsYXNzPVwid2FybmluZy1pY29uIG1yLTJcIiAvPlxuICAgICAgICAgICAgICAgICAgICA8c3BhbiAqbmdJZj1cImhhc0Vycm9yXCIgY2xhc3M9XCJtcy0yXCI+QW4gdW5leHBlY3RlZCBpc3N1ZSBvY2N1cnJlZDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4gKm5nSWY9XCJub0RhdGFcIiBjbGFzcz1cIm1zLTJcIj5UaGUgaW5wdXQgcHJvdmlkZWQgZG9lcyBub3QgaGF2ZSBlbm91Z2ggY2xpbmljYWwgZGV0YWlscyBmb3IgYW4gQUktYXNzaXN0YW50IGFzc2Vzc21lbnQuPC9zcGFuPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxidXR0b24gKm5nSWY9XCIhbm9EYXRhXCIgdHlwZT1cImJ1dHRvblwiIGNsYXNzPVwidHJ5LWFnYWluLWJ0biBtdC0zXCIgKGNsaWNrKT1cIm9uVHJ5QWdhaW4oKVwiPlxuICAgICAgICAgICAgICAgICAgICB7eydUcnkgYWdhaW4nfHRyYW5zbGF0ZX19XG4gICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cblxuICAgICAgICAgICAgPGJ1dHRvbiAqbmdJZj1cImlzTG9hZGluZ1wiIGNsYXNzPVwic3RhdHMtbG9hZGluZ1wiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJlaW5zXCI+PC9kaXY+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInp3ZWlcIj48L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwiZHJlaVwiPjwvZGl2PlxuICAgICAgICAgICAgPC9idXR0b24+XG5cbiAgICAgICAgICAgIDxkaXYgKm5nSWY9XCJpc0xvYWRpbmdcIiBjbGFzcz1cIm10LTNcIj5cbiAgICAgICAgICAgICAgICA8aSBjbGFzcz1cImJpIGJpLWV4Y2xhbWF0aW9uLXRyaWFuZ2xlLWZpbGxcIj48L2k+XG4gICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJtcy0yIGxvYWRpbmctdGV4dFwiPlBsZWFzZSB3YWl0IHdoaWxlIHRoZSByZXN1bHRzIGFyZSBiZWluZyBnZW5lcmF0ZWQuPC9zcGFuPlxuICAgICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG48L25nLWNvbnRhaW5lcj5cblxuPG5nLWNvbnRhaW5lciAqbmdJZj1cImRpYWdub3Npc0xpc3QubGVuZ3RoXCIgY2xhc3M9XCJtdC0yXCI+XG4gICAgPHAgY2xhc3M9XCJub3RlLWNvbiBtbC0yXCI+XG4gICAgICAgIDxzcGFuIGNsYXNzPVwibm90ZS1sYWJlbFwiPk5vdGU6PC9zcGFuPlxuICAgICAgICBUaGlzIGluZm9ybWF0aW9uIGlzIEFJIGdlbmVyYXRlZC4gUGxlYXNlIHJlbHkgb24geW91ciBtZWRpY2FsIGp1ZGdlbWVudCB3aGlsZSByZWZlcnJpbmcgdG8gaXQuXG4gICAgPC9wPlxuICAgIDxkaXYgY2xhc3M9XCJpbnRlbC1hY2NvcmRpb24tdGl0bGVcIj5cbiAgICAgICAgPGg2IGNsYXNzPVwibXQtMSBtbC0yIGRpZmZyZW50aWFsLWRpYWdub3Npc1wiPkRpZmZlcmVudGlhbCBEaWFnbm9zaXM8L2g2PlxuICAgIDwvZGl2PlxuICAgIDxkaXYgY2xhc3M9XCJpbnRlbC1hY2NvcmRpb24tdGl0bGVcIj5cbiAgICAgICAgPHAgY2xhc3M9XCJ0ZXh0LW11dGVkIG1iLTMgZGlhZ25vc2lzLWxpc3QgbWwtMlwiPlxuICAgICAgICAgICAgU2VsZWN0IHRoZSBkaWFnbm9zaXMgYmFzZWQgb24geW91ciBtZWRpY2FsIGp1ZGdlbWVudC5cbiAgICAgICAgPC9wPlxuICAgIDwvZGl2PlxuXG4gICAgPGRpdiBjbGFzcz1cImRpYWdub3Npcy1jb250YWluZXIgcC0zXCI+XG4gICAgICAgIDxkaXYgKm5nRm9yPVwibGV0IGRpYWdub3NpcyBvZiBkaWFnbm9zaXNMaXN0XCIgXG4gICAgICAgICAgICAgY2xhc3M9XCJkLWZsZXggYWxpZ24taXRlbXMtY2VudGVyIG1iLTJcIlxuICAgICAgICAgICAgIFtjbGFzcy5kaXNhYmxlZC1kaWFnbm9zaXNdPVwiaXNEaWFnbm9zaXNFeGlzdHMoZGlhZ25vc2lzLmRpYWdub3NpcylcIj5cbiAgICAgICAgICAgIDxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBjbGFzcz1cImN1c3RvbS1jaGVja2JveCBtZS0yXCJcbiAgICAgICAgICAgICAgICBbY2hlY2tlZF09XCJpc0RpYWdub3Npc1NlbGVjdGVkKGRpYWdub3Npcy5kaWFnbm9zaXMpXCJcbiAgICAgICAgICAgICAgICBbZGlzYWJsZWRdPVwiaXNEaWFnbm9zaXNFeGlzdHMoZGlhZ25vc2lzLmRpYWdub3NpcylcIlxuICAgICAgICAgICAgICAgIChjaGFuZ2UpPVwib25BSURpYWdub3Npc0NoYW5nZShkaWFnbm9zaXMuZGlhZ25vc2lzKVwiPlxuICAgICAgICAgICAgPGxhYmVsIGNsYXNzPVwiZnctYm9sZFwiIFtjbGFzcy50ZXh0LW11dGVkXT1cImlzRGlhZ25vc2lzRXhpc3RzKGRpYWdub3Npcy5kaWFnbm9zaXMpXCI+XG4gICAgICAgICAgICAgICAge3sgZGlhZ25vc2lzLmRpYWdub3NpcyB9fVxuICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwidGV4dC1tdXRlZCBtcy0yXCI+KGxpa2VseSB7eyBkaWFnbm9zaXMubGlrZWxpaG9vZCB9fSk8L3NwYW4+XG4gICAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cblxuICAgIDxkaXYgY2xhc3M9XCJyYXRpb25hbGUtY29udGFpbmVyXCI+XG4gICAgICAgIDxoNSBjbGFzcz1cImZ3LWJvbGQgcmF0aW9uYWxlXCI+UmF0aW9uYWxlPC9oNT5cbiAgICAgICAgPGRpdiAqbmdGb3I9XCJsZXQgcmF0aW9uYWxlIG9mIGRpYWdub3Npc0xpc3Q7IGxldCBpID0gaW5kZXhcIiBjbGFzcz1cInJhdGlvbmFsZS1pdGVtIHAtMyBtYi0yXCI+XG4gICAgICAgICAgICA8aDMgY2xhc3M9XCJmdy1ib2xkXCI+XG4gICAgICAgICAgICAgICAge3sgaSArIDEgfX0uIHt7IHJhdGlvbmFsZS5kaWFnbm9zaXMgfX1cbiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cInRleHQtbXV0ZWQgc21hbGxcIj4obGlrZWx5IHt7IHJhdGlvbmFsZS5saWtlbGlob29kIH19KTwvc3Bhbj5cbiAgICAgICAgICAgIDwvaDM+XG4gICAgICAgICAgICA8cCBjbGFzcz1cInJhdGlvbmFsZS1kZXNjcmlwdGlvblwiIFtpbm5lckhUTUxdPVwicmF0aW9uYWxlLnJhdGlvbmFsZVwiPjwvcD5cbiAgICAgICAgPC9kaXY+XG4gICAgPC9kaXY+XG5cbjwvbmctY29udGFpbmVyPlxuXG48ZGl2ICpuZ0lmPVwiY29uY2x1c2lvblwiIGNsYXNzPVwiY29uY2x1c2lvbi1jYXJkXCI+XG4gICAgPGRpdiBjbGFzcz1cImNvbmNsdXNpb24taGVhZGVyXCI+XG4gICAgICAgIDxoMj5Db25jbHVzaW9uPC9oMj5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPVwiY29uY2x1c2lvbi1ib2R5XCI+XG4gICAgICAgIDxwPnt7IGNvbmNsdXNpb24gfX08L3A+XG4gICAgPC9kaXY+XG48L2Rpdj5cblxuPCEtLSA8ZGl2PlxuICAgIDxoNiBjbGFzcz1cImZ3LWJvbGRcIj5GdXJ0aGVyIHF1ZXN0aW9uczwvaDY+XG4gICAgPGRpdiAqbmdGb3I9XCJsZXQgcXVlc3Rpb24gb2YgcXVlc3Rpb25zOyBsZXQgaSA9IGluZGV4XCIgY2xhc3M9XCJyYXRpb25hbGUtaXRlbSBwLTMgbWItM1wiPlxuICAgICAgICA8aDYgY2xhc3M9XCJmdy1ib2xkXCI+e3sgaSArIDEgfX0uIHt7IHF1ZXN0aW9uLnRpdGxlIH19PC9oNj5cbiAgICAgICAgPHVsPlxuICAgICAgICAgICAgPGxpICpuZ0Zvcj1cImxldCBpdGVtIG9mIHF1ZXN0aW9uLml0ZW1zXCI+e3sgaXRlbSB9fTwvbGk+XG4gICAgICAgIDwvdWw+XG4gICAgPC9kaXY+XG48L2Rpdj4gLS0+Il19
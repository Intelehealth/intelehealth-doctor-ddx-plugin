import { Inject, Injectable, Optional } from "@angular/core";
import { ENVIRONMENT } from "../lib/token";
import markdownit from "markdown-it";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export class AiddxService {
    http;
    env;
    constructor(http, env) {
        this.http = http;
        this.env = env;
        if (!this.env) {
            console.warn("ENVIRONMENT is not provided!");
        }
    }
    getAIDiagnosis(casehistory) {
        return this.http.post(`${this.env.base}/ddx`, { casehistory });
    }
    getDDxPayload(patientInfo, visit, notes) {
        const data = this.getDataToExtract(patientInfo, visit);
        const get = (key, fallback = "Null") => data[key] || fallback;
        const adultinitial = get("vst.encounters")?.ADULTINITIAL || [];
        const complaint = adultinitial.find((a) => a?.concept?.display?.includes?.("COMPLAINT"));
        const phyExam = adultinitial.find((a) => a?.concept?.display?.includes?.("PHYSICAL EXAMINATION"));
        const famHist = adultinitial.find((a) => a?.concept?.display?.includes?.("FAMILY HISTORY"));
        const medHist = adultinitial.find((a) => a?.concept?.display?.includes?.("MEDICAL HISTORY"));
        const vitals = get("vst.encounters")?.Vitals || [];
        const vitalPayload = `\nVitals: \n${vitals
            .map((v) => `${v?.concept?.display}: ${v?.value}`)
            .join("\n")}`;
        const payload = `Gender: ${get("pi.person.gender", "Not specified")}
Age: ${get("pi.person.age", "Not specified")}

Chief_complaint: ${this.formatText(complaint?.value || "")}

Physical_examination: ${this.formatText(phyExam?.value || "")}

Family_history: ${this.formatText(famHist?.value || "")}

Medical_history: ${this.formatText(medHist?.value || "")}

${vitals?.length ? vitalPayload : ""}

${notes ? `Notes: ${notes}` : ""}`;
        return payload;
    }
    getDataToExtract(patientInfo, visit) {
        const data = {
            ...this.flatten(patientInfo, "pi"),
            ...this.flatten(visit, "vst"),
        };
        return data;
    }
    flatten(obj = {}, parentKey = "") {
        let flatData = {};
        for (const [key, value] of Object.entries(obj)) {
            const newKey = parentKey ? `${parentKey}.${key}` : key;
            if (Array.isArray(value)) {
                if (key === "encounters") {
                    let attr = {};
                    value.forEach((item, index) => {
                        attr[item?.encounterType?.display] = item?.obs;
                    });
                    flatData[newKey] = attr;
                }
            }
            else if (typeof value === "object" && value !== null) {
                const nestedFlat = this.flatten(value, newKey);
                flatData = { ...flatData, ...nestedFlat };
            }
            else {
                flatData[newKey] = value;
            }
        }
        return flatData;
    }
    formatText(text) {
        if (!text)
            return "";
        return text
            .replace(/<br\/>/g, "\n")
            .replace(/<b>/g, "**")
            .replace(/<\/b>/g, "**")
            .replace(/►/g, "")
            .trim();
    }
    markdownit(txt) {
        const md = markdownit();
        let formattedText = txt.map(obj => {
            return Object.entries(obj).map(([key, value]) => `**${key}**: ${value}`).join("\n");
        }).join("\n\n");
        return md.renderInline(formattedText);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AiddxService, deps: [{ token: i1.HttpClient }, { token: ENVIRONMENT, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AiddxService, providedIn: "root" });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.3.0", ngImport: i0, type: AiddxService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: "root",
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [ENVIRONMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWlkZHguc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FpZGR4LWxpYnJhcnkvc3JjL3NlcnZpY2VzL2FpZGR4LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDM0MsT0FBTyxVQUFVLE1BQU0sYUFBYSxDQUFDOzs7QUFLckMsTUFBTSxPQUFPLFlBQVk7SUFFYjtJQUNpQztJQUYzQyxZQUNVLElBQWdCLEVBQ2lCLEdBQVM7UUFEMUMsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNpQixRQUFHLEdBQUgsR0FBRyxDQUFNO1FBRWxELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ2IsT0FBTyxDQUFDLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1NBQzlDO0lBQ0gsQ0FBQztJQUVELGNBQWMsQ0FBQyxXQUFnQjtRQUM3QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLE1BQU0sRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVELGFBQWEsQ0FBQyxXQUFnQixFQUFFLEtBQVUsRUFBRSxLQUFjO1FBQ3hELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkQsTUFBTSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsUUFBUSxHQUFHLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQztRQUU5RCxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxZQUFZLElB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LENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssR0FBRyxPQUFPLEtBQUssRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RGLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoQixPQUFPLEVBQUUsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDeEMsQ0FBQzt1R0F6R1UsWUFBWSw0Q0FHRCxXQUFXOzJHQUh0QixZQUFZLGNBRlgsTUFBTTs7MkZBRVAsWUFBWTtrQkFIeEIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQUlJLFFBQVE7OzBCQUFJLE1BQU07MkJBQUMsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XHJcbmltcG9ydCB7IEVOVklST05NRU5UIH0gZnJvbSBcIi4uL2xpYi90b2tlblwiO1xyXG5pbXBvcnQgbWFya2Rvd25pdCBmcm9tIFwibWFya2Rvd24taXRcIjtcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiBcInJvb3RcIixcclxufSlcclxuZXhwb3J0IGNsYXNzIEFpZGR4U2VydmljZSB7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXHJcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEVOVklST05NRU5UKSBwcml2YXRlIGVudj86IGFueVxyXG4gICkge1xyXG4gICAgaWYgKCF0aGlzLmVudikge1xyXG4gICAgICBjb25zb2xlLndhcm4oXCJFTlZJUk9OTUVOVCBpcyBub3QgcHJvdmlkZWQhXCIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0QUlEaWFnbm9zaXMoY2FzZWhpc3Rvcnk6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KGAke3RoaXMuZW52LmJhc2V9L2RkeGAsIHsgY2FzZWhpc3RvcnkgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRERHhQYXlsb2FkKHBhdGllbnRJbmZvOiBhbnksIHZpc2l0OiBhbnksIG5vdGVzPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5nZXREYXRhVG9FeHRyYWN0KHBhdGllbnRJbmZvLCB2aXNpdCk7XHJcbiAgICBjb25zdCBnZXQgPSAoa2V5LCBmYWxsYmFjayA9IFwiTnVsbFwiKSA9PiBkYXRhW2tleV0gfHwgZmFsbGJhY2s7XHJcblxyXG4gICAgY29uc3QgYWR1bHRpbml0aWFsID0gZ2V0KFwidnN0LmVuY291bnRlcnNcIik/LkFEVUxUSU5JVElBTCB8fCBbXTtcclxuICAgIGNvbnN0IGNvbXBsYWludCA9IGFkdWx0aW5pdGlhbC5maW5kKChhKSA9PlxyXG4gICAgICBhPy5jb25jZXB0Py5kaXNwbGF5Py5pbmNsdWRlcz8uKFwiQ09NUExBSU5UXCIpXHJcbiAgICApO1xyXG4gICAgY29uc3QgcGh5RXhhbSA9IGFkdWx0aW5pdGlhbC5maW5kKChhKSA9PlxyXG4gICAgICBhPy5jb25jZXB0Py5kaXNwbGF5Py5pbmNsdWRlcz8uKFwiUEhZU0lDQUwgRVhBTUlOQVRJT05cIilcclxuICAgICk7XHJcbiAgICBjb25zdCBmYW1IaXN0ID0gYWR1bHRpbml0aWFsLmZpbmQoKGEpID0+XHJcbiAgICAgIGE/LmNvbmNlcHQ/LmRpc3BsYXk/LmluY2x1ZGVzPy4oXCJGQU1JTFkgSElTVE9SWVwiKVxyXG4gICAgKTtcclxuICAgIGNvbnN0IG1lZEhpc3QgPSBhZHVsdGluaXRpYWwuZmluZCgoYSkgPT5cclxuICAgICAgYT8uY29uY2VwdD8uZGlzcGxheT8uaW5jbHVkZXM/LihcIk1FRElDQUwgSElTVE9SWVwiKVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCB2aXRhbHMgPSBnZXQoXCJ2c3QuZW5jb3VudGVyc1wiKT8uVml0YWxzIHx8IFtdO1xyXG4gICAgY29uc3Qgdml0YWxQYXlsb2FkID0gYFxcblZpdGFsczogXFxuJHt2aXRhbHNcclxuICAgICAgLm1hcCgodikgPT4gYCR7dj8uY29uY2VwdD8uZGlzcGxheX06ICR7dj8udmFsdWV9YClcclxuICAgICAgLmpvaW4oXCJcXG5cIil9YDtcclxuXHJcbiAgICBjb25zdCBwYXlsb2FkID0gYEdlbmRlcjogJHtnZXQoXCJwaS5wZXJzb24uZ2VuZGVyXCIsIFwiTm90IHNwZWNpZmllZFwiKX1cclxuQWdlOiAke2dldChcInBpLnBlcnNvbi5hZ2VcIiwgXCJOb3Qgc3BlY2lmaWVkXCIpfVxyXG5cclxuQ2hpZWZfY29tcGxhaW50OiAke3RoaXMuZm9ybWF0VGV4dChjb21wbGFpbnQ/LnZhbHVlIHx8IFwiXCIpfVxyXG5cclxuUGh5c2ljYWxfZXhhbWluYXRpb246ICR7dGhpcy5mb3JtYXRUZXh0KHBoeUV4YW0/LnZhbHVlIHx8IFwiXCIpfVxyXG5cclxuRmFtaWx5X2hpc3Rvcnk6ICR7dGhpcy5mb3JtYXRUZXh0KGZhbUhpc3Q/LnZhbHVlIHx8IFwiXCIpfVxyXG5cclxuTWVkaWNhbF9oaXN0b3J5OiAke3RoaXMuZm9ybWF0VGV4dChtZWRIaXN0Py52YWx1ZSB8fCBcIlwiKX1cclxuXHJcbiR7dml0YWxzPy5sZW5ndGggPyB2aXRhbFBheWxvYWQgOiBcIlwifVxyXG5cclxuJHtub3RlcyA/IGBOb3RlczogJHtub3Rlc31gIDogXCJcIn1gO1xyXG5cclxuICAgIHJldHVybiBwYXlsb2FkO1xyXG4gIH1cclxuXHJcbiAgZ2V0RGF0YVRvRXh0cmFjdChwYXRpZW50SW5mbzogYW55LCB2aXNpdDogYW55KSB7XHJcbiAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAuLi50aGlzLmZsYXR0ZW4ocGF0aWVudEluZm8sIFwicGlcIiksXHJcbiAgICAgIC4uLnRoaXMuZmxhdHRlbih2aXNpdCwgXCJ2c3RcIiksXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGRhdGE7XHJcbiAgfVxyXG5cclxuICBmbGF0dGVuKG9iaiA9IHt9LCBwYXJlbnRLZXkgPSBcIlwiKSB7XHJcbiAgICBsZXQgZmxhdERhdGEgPSB7fTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XHJcbiAgICAgIGNvbnN0IG5ld0tleSA9IHBhcmVudEtleSA/IGAke3BhcmVudEtleX0uJHtrZXl9YCA6IGtleTtcclxuXHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgIGlmIChrZXkgPT09IFwiZW5jb3VudGVyc1wiKSB7XHJcbiAgICAgICAgICBsZXQgYXR0ciA9IHt9O1xyXG4gICAgICAgICAgdmFsdWUuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgYXR0cltpdGVtPy5lbmNvdW50ZXJUeXBlPy5kaXNwbGF5XSA9IGl0ZW0/Lm9icztcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgZmxhdERhdGFbbmV3S2V5XSA9IGF0dHI7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIiAmJiB2YWx1ZSAhPT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IG5lc3RlZEZsYXQgPSB0aGlzLmZsYXR0ZW4odmFsdWUsIG5ld0tleSk7XHJcbiAgICAgICAgZmxhdERhdGEgPSB7IC4uLmZsYXREYXRhLCAuLi5uZXN0ZWRGbGF0IH07XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZmxhdERhdGFbbmV3S2V5XSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZsYXREYXRhO1xyXG4gIH1cclxuXHJcbiAgZm9ybWF0VGV4dCh0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKCF0ZXh0KSByZXR1cm4gXCJcIjtcclxuXHJcbiAgICByZXR1cm4gdGV4dFxyXG4gICAgICAucmVwbGFjZSgvPGJyXFwvPi9nLCBcIlxcblwiKVxyXG4gICAgICAucmVwbGFjZSgvPGI+L2csIFwiKipcIilcclxuICAgICAgLnJlcGxhY2UoLzxcXC9iPi9nLCBcIioqXCIpXHJcbiAgICAgIC5yZXBsYWNlKC/ilrovZywgXCJcIilcclxuICAgICAgLnRyaW0oKTtcclxuICB9XHJcblxyXG4gIG1hcmtkb3duaXQodHh0OiBhbnkpIHtcclxuICAgIGNvbnN0IG1kID0gbWFya2Rvd25pdCgpO1xyXG4gICAgbGV0IGZvcm1hdHRlZFRleHQgPSB0eHQubWFwKG9iaiA9PiB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2tleSwgdmFsdWVdKSA9PiBgKioke2tleX0qKjogJHt2YWx1ZX1gKS5qb2luKFwiXFxuXCIpO1xyXG4gICAgfSkuam9pbihcIlxcblxcblwiKTtcclxuICAgIHJldHVybiBtZC5yZW5kZXJJbmxpbmUoZm9ybWF0dGVkVGV4dCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==